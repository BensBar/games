<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BenBlinko: Combo Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Manrope:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100vw;
      background: #161c2c;
      font-family: 'Manrope', 'Orbitron', Arial, sans-serif;
      overflow: hidden;
      color: #fff;
    }
    #bg-anim {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 0; pointer-events: none;
    }
    #game-container {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 2;
    }
    #ui-bar {
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 34px;
      margin: 16px 0 0 0;
      z-index: 4;
      font-size: 1.18em;
      pointer-events: none;
      user-select: none;
    }
    .ui-glass {
      background: rgba(34, 53, 88, 0.82);
      padding: 13px 25px;
      border-radius: 18px;
      border: 2px solid #7fd7f8;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 9px #b7aaf7, 0 0 3px #000;
      letter-spacing: 1px;
      box-shadow: 0 0 12px #7fd7f899 inset, 0 2px 8px #0002;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.13em;
      min-width: 62px;
      justify-content: center;
      backdrop-filter: blur(5px);
      transition: background 0.2s, border 0.2s, color 0.2s;
    }
    #score-box, #highscore-box, #ball-box, #multiplier-box {
      /* shared glass styles */
    }
    .score-icon {
      font-size: 1.13em;
      filter: drop-shadow(0 0 8px #b7aaf7);
      margin-right: 3px;
    }
    #multiplier-box {
      min-width: 84px;
      background: linear-gradient(90deg,#ffe24b99 25%,#ff89aa55 100%);
      color: #222;
      border: 2.5px solid #ffe24b;
      box-shadow: 0 0 14px #ffe24b44, 0 0 2px #fa43a7;
      font-weight: bold;
      font-size: 1.12em;
      display: flex !important;
      justify-content: center;
      align-items: center;
      transition: background 0.21s, color 0.21s, border 0.18s;
      animation: pulse 1.1s infinite alternate;
      opacity: 1;
    }
    #multiplier-box.inactive {
      background: rgba(34,53,88,0.82);
      color: #bbb;
      border: 2px solid #7fd7f8;
      box-shadow: none;
      animation: none;
      opacity: 0.8;
    }
    #multiplier-box .bonus-label {
      margin-left: 7px;
      font-size: 0.92em;
      opacity: 0.78;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    #multiplier-box .bonus-label.inactive {
      color: #bbb;
      opacity: 0.7;
    }
    @keyframes pulse {
      from { box-shadow: 0 0 8px #ffe24b77;}
      to { box-shadow: 0 0 24px #ffe24bcc;}
    }
    #help-btn {
      margin-left: 18px;
      padding: 10px 18px;
      border-radius: 10px;
      border: 2px solid #7fd7f8;
      background: rgba(33, 48, 82, 0.94);
      color: #7fd7f8;
      font-size: 1.10em;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      box-shadow: 0 2px 10px #7fd7f855;
      pointer-events: auto;
      transition: 0.13s;
      backdrop-filter: blur(2px);
    }
    #help-btn:hover {
      background: #7fd7f8;
      color: #1d2438;
      border-color: #b7aaf7;
    }
    #game-canvas {
      display: block;
      margin: 0 auto;
      background: transparent;
      border: 4px solid #7fd7f8;
      border-radius: 33px;
      box-shadow: 0 0 70px #b7aaf7a9, 0 0 14px #1a2237;
      z-index: 2;
      margin-bottom: 10px;
      margin-top: 10px;
    }
    #instructions {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(23,29,55,0.97);
      display: none;
      align-items: center; justify-content: center;
      z-index: 10;
      text-align: center;
      flex-direction: column;
      border-radius: 0;
      padding: 0;
      animation: fadeIn 0.6s;
    }
    #instructions.visible { display: flex; }
    #instructions-content {
      background: rgba(32,38,56,0.99);
      border-radius: 28px;
      padding: 38px 28px 28px 28px;
      box-shadow: 0 8px 44px #7fd7f8cc;
      border: 3.0px solid #7fd7f8;
      max-width: 96vw;
      animation: popIn 0.45s cubic-bezier(.32,1.56,.53,.92);
    }
    #instructions h2 {
      font-size: 2.0em;
      margin-bottom: 0.3em;
      color: #7fd7f8;
      text-shadow: 0 0 28px #7fd7f8;
      letter-spacing: 1.2px;
    }
    #instructions ul {
      text-align: left;
      margin: 0 auto 16px auto;
      padding-left: 18px;
      max-width: 440px;
      color: #e7fafd;
      font-size: 1.12em;
      line-height: 1.7;
      text-shadow: 0 0 6px #7fd7f822, 0 0 2px #111;
    }
    #instructions .peg-demo {
      display: inline-block;
      width: 22px; height:22px;
      border-radius: 50%;
      background: #ffe24b;
      box-shadow: 0 0 13px #ffe24bcc, 0 0 6px #ff89aa;
      vertical-align: middle;
      margin:0 2px 0 0;
    }
    #instructions button {
      margin-top: 19px;
      font-size: 1.08em;
      padding: 10px 28px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg,#7fd7f8,#b7aaf7);
      color: #1d2438;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 10px #7fd7f8c9;
      transition: 0.12s;
    }
    #instructions button:hover {
      background: #b7aaf7;
      color: #222;
    }
    #welcome {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(22,28,48,0.965);
      z-index: 15;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.7s;
    }
    #welcome h1 {
      font-size: 2.5em;
      margin: 0.5em;
      text-shadow: 0 0 34px #7fd7f8, 0 0 60px #b7aaf7;
      letter-spacing: 3px;
      color: #7fd7f8;
      font-family: Orbitron, Manrope, Arial, sans-serif;
    }
    #welcome p {
      font-size: 1.13em;
      margin: 0.3em 0 1em;
      color: #e7fafd;
      text-shadow: 0 0 10px #111a;
      max-width: 460px;
      font-family: 'Manrope', Arial, sans-serif;
    }
    #start-btn {
      padding: 15px 36px;
      font-size: 1.21em;
      border: none;
      border-radius: 15px;
      background: linear-gradient(90deg, #7fd7f8 40%, #b7aaf7 100%);
      color: #1d2438;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 8px 32px #7fd7f8bb, 0 2px 8px #b7aaf7aa;
      transition: 0.15s;
      margin-top: 1em;
    }
    #start-btn:hover {
      background: linear-gradient(90deg, #b7aaf7, #7fd7f8);
      color: #000;
      transform: scale(1.04);
    }
    #gameover-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(23,29,55,0.97);
      z-index: 20;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      animation: fadeIn 0.6s;
    }
    #gameover-modal.visible { display: flex; }
    #gameover-content {
      background: rgba(32,38,56,0.99);
      border-radius: 30px;
      padding: 40px 28px 28px 28px;
      box-shadow: 0 10px 48px #7fd7f8cc;
      border: 3.0px solid #7fd7f8;
      max-width: 95vw;
      animation: popIn 0.5s cubic-bezier(.32,1.56,.53,.92);
      text-align: center;
    }
    #gameover-content h2 {
      color: #ffe24b;
      font-size: 2.1em;
      margin-bottom:0.2em;
      text-shadow: 0 0 18px #ffe24b, 0 0 10px #fff3;
    }
    #gameover-content .final-score {
      font-size: 1.7em;
      color: #fff;
      margin: 0.5em 0 0.2em 0;
      text-shadow: 0 0 19px #7fd7f8b0;
    }
    #gameover-content .highscore {
      font-size: 1.09em;
      margin-bottom: 1em;
      color: #7fd7f8;
      text-shadow: 0 0 12px #b7aaf7;
    }
    #gameover-content button {
      margin-top: 14px;
      font-size: 1.08em;
      padding: 10px 33px;
      border-radius: 13px;
      border: none;
      background: linear-gradient(90deg,#7fd7f8,#ffe24b);
      color: #1d2438;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 12px #7fd7f8c9;
      transition: 0.12s;
    }
    #gameover-content button:hover {
      background: #ffe24b;
      color: #222;
    }
    @keyframes fadeIn {
      from { opacity:0 }
      to { opacity:1 }
    }
    @keyframes popIn {
      0%   { transform: scale(0.92);}
      100% { transform: scale(1);}
    }
    @media (max-width: 700px) {
      #instructions-content, #gameover-content { font-size: 1em; }
      #welcome h1 { font-size: 1.6em;}
      #ui-bar { font-size: 1em; gap: 15px;}
      .ui-glass { padding: 7px 7px; font-size: 0.98em;}
      #multiplier-box { min-width: 60px;}
    }
  </style>
</head>
<body>
  <canvas id="bg-anim"></canvas>
  <div id="game-container">
    <div id="ui-bar">
      <span id="score-box" class="ui-glass"><span class="score-icon">üèÜ</span><span id="score-val">0</span></span>
      <span id="highscore-box" class="ui-glass"><span class="score-icon">‚≠ê</span><span id="highscore-val">0</span></span>
      <span id="ball-box" class="ui-glass"><span class="score-icon">üî¥</span><span id="ball-val">1/5</span></span>
      <span id="multiplier-box" class="ui-glass inactive"><span id="multi-x">x2</span><span class="bonus-label inactive">COMBO</span></span>
      <button id="help-btn" style="pointer-events:auto;">‚ùî</button>
    </div>
    <canvas id="game-canvas"></canvas>
  </div>
  <div id="instructions">
    <div id="instructions-content">
      <h2>How to Play</h2>
      <ul>
        <li>üéÆ <b>Tilt</b> your device (or use <b>‚Üê/‚Üí arrow keys</b>) to steer the ball.</li>
        <li>‚ú® <b>Bounce</b> off pegs and aim for the <b>center slot</b> for the best prize!</li>
        <li>üåü <span class="peg-demo"></span> <b>Combo Pegs:</b> Hit a colored peg for a score multiplier on that ball!</li>
        <li>üî¥ <b>5 balls per game</b>. Try to beat your high score!</li>
      </ul>
      <button id="close-instructions">Back to Game</button>
    </div>
  </div>
  <div id="welcome">
    <h1>BenBlinko</h1>
    <p>
      Tilt your device (or use arrow keys) to steer the ball.<br>
      Bounce off pegs and land in a slot for points!<br>
      Hit the colored pegs for a combo!<br>
      Try to beat your high score!
    </p>
    <button id="start-btn">Start Game</button>
    <button id="help-btn-welcome" style="margin-top:20px;">How to Play</button>
  </div>
  <div id="gameover-modal">
    <div id="gameover-content">
      <h2>Game Over!</h2>
      <div class="final-score">Score: <span id="final-score-val">0</span></div>
      <div class="highscore">High Score: <span id="highscore-final">0</span></div>
      <button id="play-again-btn">Play Again</button>
    </div>
  </div>
  <script>
    // Animated gradient BG
    const bg = document.getElementById('bg-anim');
    bg.width = window.innerWidth; bg.height = window.innerHeight;
    const bgctx = bg.getContext('2d');
    let gradTime = 0;
    function drawBg() {
      gradTime += 0.007;
      let w = bg.width, h = bg.height;
      let g = bgctx.createLinearGradient(
        w/2 + Math.sin(gradTime)*w/4,
        h/2 + Math.cos(gradTime/2)*h/4,
        w/2 + Math.cos(gradTime*1.6)*w/3,
        h/2 + Math.sin(gradTime/1.3)*h/3
      );
      g.addColorStop(0, `#223d54`);
      g.addColorStop(0.14, `#4f6fb2`);
      g.addColorStop(0.33, `#7fd7f8`);
      g.addColorStop(0.66, `#b7aaf7`);
      g.addColorStop(1, `#161c2c`);
      bgctx.fillStyle = g;
      bgctx.fillRect(0,0,w,h);
      requestAnimationFrame(drawBg);
    }
    drawBg();
    window.addEventListener('resize', () => {
      bg.width = window.innerWidth;
      bg.height = window.innerHeight;
    });

    // Responsive Canvas
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() {
      // 9:16 aspect ratio, fill screen
      const ww = window.innerWidth;
      const wh = window.innerHeight - 70;
      let w = ww, h = wh;
      if (w / h > 9/16) w = h * 9/16;
      else h = w * 16/9;
      canvas.width = w;
      canvas.height = h;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Game elements scale
    let tilt = 0, tiltReady = false;
    let score = 0, highscore = 0, ballsLeft = 5, ballNum = 1;
    let comboActive = false, comboMultiplier = 1, comboPegIdxs = [];
    document.getElementById('score-val').textContent = score;
    document.getElementById('highscore-val').textContent = highscore;
    document.getElementById('ball-val').textContent = `${ballNum}/5`;

    // Board setup
    function getBoardSpec() {
      const w = canvas.width, h = canvas.height;
      const boardMarginX = w*0.045, boardMarginY = h*0.04;
      const boardW = w - 2*boardMarginX;
      const boardH = h - 2*boardMarginY - h*0.11;
      const slotCount = 7;
      const pegRows = 10;
      const pegCols = 10;
      const pegRadius = boardW*0.012;
      const ballRadius = boardW*0.023;
      const slotH = boardH*0.11;
      return {
        x: boardMarginX,
        y: boardMarginY,
        w: boardW,
        h: boardH,
        slotCount,
        pegRows,
        pegCols,
        pegRadius,
        ballRadius,
        slotH
      };
    }
    function getSlots(spec) {
      const widths = [1,1,1,0.7,1,1,1];
      const total = widths.reduce((a,b) => a+b,0);
      let pos = spec.x;
      return Array.from({length: spec.slotCount}, (_, i) => {
        let w = spec.w * widths[i]/total;
        let slot = {
          x: pos,
          w: w,
          reward: [10,40,120,400,120,40,10][i],
          color: [
            "#7fd7f8", "#b7aaf7", "#8dd6e8", "#7fd7f8",
            "#8dd6e8", "#b7aaf7", "#7fd7f8"
          ][i]
        };
        pos += w;
        return slot;
      });
    }
    function getPegs(spec) {
      let pegs = [];
      for (let row = 0; row < spec.pegRows; row++) {
        for (let col = 0; col < spec.pegCols; col++) {
          let xOffset = (row%2 ? (spec.w/spec.pegCols)/2 : 0);
          let px = spec.x + col*(spec.w/spec.pegCols) + xOffset;
          let py = spec.y + row*((spec.h-spec.slotH*1.15)/spec.pegRows) + spec.pegRadius*1.7;
          pegs.push({x: px, y: py, sparkle: 0, color: "#fff", combo: false});
        }
      }
      return pegs;
    }

    // Ball, Trail, Confetti
    let ball = null, ballTrail = [],
        slots = [], pegs = [], spec = getBoardSpec();

    let lastX = 0, xSameCount = 0;

    function randomComboPegs() {
      let count = 2 + Math.floor(Math.random()*3);
      let idxs = [];
      while (idxs.length < count) {
        let idx = Math.floor(Math.random()*pegs.length);
        if (!idxs.includes(idx) && !isPegEdge(idx)) idxs.push(idx);
      }
      comboPegIdxs = idxs;
      comboMultiplier = [2,2,3,4][count-2];
      comboActive = false;
      pegs.forEach((p,i) => p.combo = idxs.includes(i));
      updateMultiplierUI();
    }
    function isPegEdge(idx) {
      let p = pegs[idx];
      return p.x < spec.x + spec.w*0.13 || p.x > spec.x + spec.w*0.87;
    }
    function updateMultiplierUI() {
      let mb = document.getElementById('multiplier-box');
      let mx = document.getElementById('multi-x');
      let label = mb.querySelector('.bonus-label');
      mb.classList.remove('inactive');
      if (!comboActive) {
        mb.classList.add('inactive');
        mx.textContent = `x${comboMultiplier}`;
        if (!label) {
          mb.insertAdjacentHTML('beforeend','<span class="bonus-label inactive">COMBO</span>');
        } else {
          label.textContent = "COMBO";
          label.classList.add('inactive');
        }
      } else {
        mx.textContent = `x${comboMultiplier}`;
        if (!label) {
          mb.insertAdjacentHTML('beforeend','<span class="bonus-label">COMBO</span>');
        } else {
          label.textContent = "COMBO!";
          label.classList.remove('inactive');
        }
      }
    }

    function spawnBall() {
      spec = getBoardSpec();
      slots = getSlots(spec);
      pegs = getPegs(spec);
      ball = {
        x: spec.x + spec.w/2,
        y: spec.y + spec.ballRadius,
        r: spec.ballRadius,
        vx: 0,
        vy: 0,
        hue: Math.floor(Math.random()*360),
        stopped: false,
        slotIdx: -1,
        confetti: []
      };
      ballTrail = [];
      lastX = ball.x;
      xSameCount = 0;
      randomComboPegs();
      document.getElementById('ball-val').textContent = `${ballNum}/5`;
      updateMultiplierUI();
    }

    function update() {
      if (!ball || ball.stopped) return;
      ball.vy += spec.h*0.00014;
      ball.vx += tilt * 0.009;
      ball.x += ball.vx;
      ball.y += ball.vy;
      ball.hue = (ball.hue + 2) % 360;

      ballTrail.unshift({x: ball.x, y: ball.y, hue: ball.hue});
      if (ballTrail.length > 40) ballTrail.pop();

      if (ball.x - ball.r < spec.x) {
        ball.x = spec.x + ball.r + 0.2;
        ball.vx = Math.abs(ball.vx)*0.8 + 1.0*Math.random()+0.3;
      }
      if (ball.x + ball.r > spec.x + spec.w) {
        ball.x = spec.x + spec.w - ball.r - 0.2;
        ball.vx = -Math.abs(ball.vx)*0.8 - 1.0*Math.random()-0.3;
      }

      pegs.forEach((p, i) => {
        const dx = ball.x - p.x;
        const dy = ball.y - p.y;
        const dist = Math.hypot(dx, dy);
        if (dist < ball.r + spec.pegRadius) {
          const angle = Math.atan2(dy, dx);
          const overlap = ball.r + spec.pegRadius - dist + 0.8;
          ball.x += Math.cos(angle) * overlap;
          ball.y += Math.sin(angle) * overlap;
          const nudge = (Math.random()-0.5)*1.3;
          ball.vx = Math.cos(angle + Math.PI/2) * 0.8 + nudge;
          ball.vy *= 0.96 + (Math.random()-0.5)*0.1;
          if (ball.x < spec.x + spec.w*0.16) ball.vx += 0.5 + Math.random()*0.2;
          if (ball.x > spec.x + spec.w*0.84) ball.vx -= 0.5 + Math.random()*0.2;
          p.sparkle = 1.0;
          if (p.combo && !comboActive) {
            comboActive = true;
            updateMultiplierUI();
          }
        }
        p.sparkle *= 0.93;
      });

      if (Math.abs(ball.x - lastX) < 0.6) xSameCount++;
      else xSameCount = 0;
      lastX = ball.x;
      if (xSameCount > 10) {
        if (ball.x < spec.x + spec.w/2) ball.vx += 1.0+Math.random();
        else ball.vx -= 1.0+Math.random();
        xSameCount = 0;
      }

      if (ball.y + ball.r >= spec.y + spec.h - spec.slotH) {
        ball.stopped = true;
        const idx = slots.findIndex(s => ball.x > s.x && ball.x < s.x + s.w);
        if (idx !== -1) {
          ball.x = slots[idx].x + slots[idx].w / 2;
          let addScore = slots[idx].reward * (comboActive ? comboMultiplier : 1);
          score += addScore;
          document.getElementById('score-val').textContent = score;
          if (score > highscore) {
            highscore = score;
            document.getElementById('highscore-val').textContent = highscore;
            localStorage.setItem('blinkoHighScore', highscore);
          }
          ball.slotIdx = idx;
          for (let i=0; i<22; ++i) {
            ball.confetti.push({
              x: ball.x,
              y: spec.y + spec.h - spec.slotH,
              vx: Math.cos(i/22*2*Math.PI)* (1.1+Math.random()*1.5) * (spec.w/320),
              vy: -2.0 - Math.random()*2.0 * (spec.h/540),
              color: slots[idx].color,
              t: 0
            });
          }
        }
        setTimeout(() => {
          if (ballNum < 5) {
            ballNum++;
            comboActive = false;
            updateMultiplierUI();
            spawnBall();
          } else {
            showGameOver();
          }
        }, 1100);
      }

      if (ball && ball.confetti) {
        for (let c of ball.confetti) {
          c.x += c.vx;
          c.y += c.vy;
          c.vy += spec.h*0.00013;
          c.t += 1;
        }
        ball.confetti = ball.confetti.filter(c => c.y < canvas.height && c.t < 80);
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      slots.forEach((s, i) => {
        ctx.save();
        let pulse = (ball && ball.stopped && ball.slotIdx === i) ? (1+Math.sin(performance.now()/80))/2 : 0;
        ctx.fillStyle = s.color;
        ctx.shadowColor = "#fff";
        ctx.shadowBlur = 22*pulse;
        ctx.fillRect(s.x, spec.y + spec.h - spec.slotH, s.w, spec.slotH);
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 0.16;
        ctx.fillStyle = '#000';
        ctx.fillRect(s.x, spec.y + spec.h - spec.slotH - 8, s.w, 8);
        ctx.globalAlpha = 1;
        ctx.font = `bold ${Math.round(spec.slotH*0.29)}px Orbitron, monospace`;
        ctx.fillStyle = '#223d54';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = "#fff";
        ctx.shadowBlur = 8;
        ctx.fillText(s.reward, s.x + s.w / 2, spec.y + spec.h - spec.slotH/2);
        ctx.restore();
      });
      pegs.forEach((p, i) => {
        ctx.save();
        let color = "#fff";
        let radius = spec.pegRadius;
        let alpha = 0.93;
        if (p.combo) {
          color = "#ffe24b";
          radius = spec.pegRadius * (1.13 + 0.05*Math.sin(performance.now()/120 + i));
          alpha = 0.93 + 0.07 * Math.abs(Math.sin(performance.now()/160 + i));
        }
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI*2);
        ctx.shadowColor = color;
        ctx.shadowBlur = p.combo ? 14 : 7;
        ctx.globalAlpha = alpha * (0.5 + 0.5*p.sparkle);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.restore();
        p.sparkle *= 0.93;
      });
      for (let i=ballTrail.length-1; i>0; i--) {
        let t = i/ballTrail.length;
        ctx.save();
        ctx.beginPath();
        ctx.arc(ballTrail[i].x, ballTrail[i].y, ball.r*(0.80+0.17*t), 0, Math.PI*2);
        ctx.globalAlpha = 0.09 + 0.13*t;
        ctx.fillStyle = `hsl(${ballTrail[i].hue},65%,${61+10*t}%)`;
        ctx.shadowColor = "#b7aaf7";
        ctx.shadowBlur = 10*t;
        ctx.fill();
        ctx.restore();
      }
      if (ball) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
        ctx.fillStyle = `hsl(${ball.hue},66%,74%)`;
        ctx.shadowColor = '#7fd7f8';
        ctx.shadowBlur = 20 + 7*Math.sin(performance.now()/130);
        ctx.globalAlpha = 0.97;
        ctx.fill();
        ctx.restore();
      }
      if (ball && ball.confetti) {
        for (let c of ball.confetti) {
          ctx.save();
          ctx.globalAlpha = Math.max(0, 1 - c.t/80);
          ctx.fillStyle = c.color;
          ctx.beginPath();
          ctx.arc(c.x, c.y, 2.1+Math.sin(c.t/3)*1.05, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }
    }

    function loop() { update(); draw(); requestAnimationFrame(loop);}
    function initTilt() {
      if (window.DeviceOrientationEvent?.requestPermission) {
        DeviceOrientationEvent.requestPermission().then(p => {
          if (p === 'granted') {
            tiltReady = true;
            window.addEventListener('deviceorientation', onTilt);
          }
        });
      } else {
        window.addEventListener('deviceorientation', onTilt);
        tiltReady = true;
      }
    }
    function onTilt(e) { tilt = e.gamma || 0; }
    function gameStart() {
      document.getElementById('welcome').style.display = 'none';
      document.getElementById('gameover-modal').classList.remove('visible');
      document.getElementById('game-container').style.display = 'flex';
      resizeCanvas();
      score = 0; ballNum = 1; ballsLeft = 5;
      comboActive = false;
      updateMultiplierUI();
      document.getElementById('score-val').textContent = score;
      document.getElementById('ball-val').textContent = `${ballNum}/5`;
      document.getElementById('highscore-val').textContent = localStorage.getItem('blinkoHighScore')||0;
      spawnBall();
      initTilt();
      requestAnimationFrame(loop);
    }
    document.getElementById('start-btn').onclick = gameStart;
    function showInstructions() { document.getElementById('instructions').classList.add('visible'); }
    function hideInstructions() { document.getElementById('instructions').classList.remove('visible'); }
    document.getElementById('help-btn').onclick = showInstructions;
    document.getElementById('help-btn-welcome').onclick = showInstructions;
    document.getElementById('close-instructions').onclick = hideInstructions;
    function showGameOver() {
      document.getElementById('final-score-val').textContent = score;
      document.getElementById('highscore-final').textContent = localStorage.getItem('blinkoHighScore')||0;
      document.getElementById('gameover-modal').classList.add('visible');
    }
    document.getElementById('play-again-btn').onclick = gameStart;
    window.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft') tilt -= 1.1;
      if (e.key === 'ArrowRight') tilt += 1.1;
      if (e.key === 'Escape') {
        hideInstructions();
        document.getElementById('gameover-modal').classList.remove('visible');
      }
    });
    window.addEventListener('DOMContentLoaded', ()=>{
      highscore = parseInt(localStorage.getItem('blinkoHighScore')||'0')||0;
      document.getElementById('highscore-val').textContent = highscore;
    });
    window.addEventListener('resize', () => {
      resizeCanvas();
      spec = getBoardSpec();
      slots = getSlots(spec);
      pegs = getPegs(spec);
    });
  </script>
</body>
</html>