<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BenBlinko: Ultimate Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Manrope:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100vw;
      background: #161c2c;
      font-family: 'Manrope', 'Orbitron', Arial, sans-serif;
      overflow-x: hidden;
      color: #fff;
    }
    /* Super top bar */
    #top-bar {
      position: fixed;
      top: 0; left: 0; width: 100vw;
      z-index: 1000;
      background: linear-gradient(90deg,#202a40cc,#1e3b5add 80%);
      box-shadow: 0 8px 28px #0009;
      min-height: 128px;
      height: 128px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      padding: 0;
    }
    #logo-img {
      height: 92px;
      width: auto;
      max-width: 340px;
      background: rgba(255,255,255,0.97);
      border-radius: 25px;
      padding: 18px 34px;
      margin-left: 0;
      margin-right: 0;
      margin-top: 0;
      margin-bottom: 0;
      box-shadow: 0 2px 38px #7fd7f8ee, 0 0 12px #ffe24b99;
      filter: drop-shadow(0 2px 16px #7fd7f8cc);
      object-fit: contain;
      display: block;
    }
    #score-bar {
      display: flex;
      align-items: center;
      gap: 36px;
      background: rgba(34, 53, 88, 0.94);
      border-radius: 20px;
      box-shadow: 0 2px 18px #7fd7f8aa inset,0 0 0 2px #ffe24b44;
      padding: 24px 44px;
      font-size: 1.38em;
      font-family: 'Orbitron', 'Manrope', Arial, sans-serif;
      justify-content: center;
    }
    .score {
      background: rgba(255,255,255,0.13);
      padding: 11px 23px;
      border-radius: 15px;
      border: 3px solid #7fd7f8cc;
      font-weight: bold;
      color: #222;
      background: rgba(255,255,255,0.73);
      text-shadow: 0 0 10px #b7aaf7, 0 0 2px #000;
      letter-spacing: 1.2px;
      box-shadow: 0 0 15px #7fd7f8aa inset;
      display: flex;
      align-items: center;
      min-width: 70px;
      justify-content: center;
      gap: 8px;
      font-size: 1.17em;
      color: #151c30;
    }
    #multiplier-box {
      min-width: 96px;
      background: linear-gradient(90deg,#ffe24bdf 44%,#ff89aa99 100%);
      color: #222;
      border: 3px solid #ffe24b;
      font-weight: bold;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 1px;
      white-space: nowrap;
      gap: 0;
      transition: background 0.18s, color 0.12s, border 0.13s, min-width 0.13s;
      box-shadow: 0 0 18px #ffe24b66, 0 0 8px #ff89aa44;
    }
    #multiplier-box.inactive {
      background: rgba(255,255,255,0.73);
      color: #bbb;
      border: 3px solid #7fd7f8;
      opacity: 0.8;
      box-shadow: none;
    }
    #multiplier-box .bonus-label {
      margin-left: 9px;
      font-size: 1em;
      opacity: 0.91;
      font-weight: 900;
      white-space: nowrap;
      padding-left: 0;
      padding-right: 0;
      color: #a97f00;
    }
    #multiplier-box .bonus-label.inactive {
      color: #bbb;
      opacity: 0.65;
    }
    #help-btn {
      margin-left: 12px;
      padding: 13px 24px;
      border-radius: 14px;
      border: 3px solid #7fd7f8;
      background: linear-gradient(90deg, #242a42 70%, #7fd7f822 100%);
      color: #7fd7f8;
      font-size: 1.25em;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      box-shadow: 0 2px 14px #7fd7f855;
      transition: 0.13s;
      backdrop-filter: blur(1px);
      animation: pulseBtn 1.2s infinite alternate;
    }
    #help-btn:hover {
      background: #7fd7f8;
      color: #1d2438;
      border-color: #b7aaf7;
      transform: scale(1.08);
    }
    @keyframes pulseBtn {
      from { box-shadow: 0 0 9px #7fd7f888;}
      to { box-shadow: 0 0 18px #ffe24b66;}
    }
    #game-container {
      box-sizing: border-box;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 148px; /* match or exceed #top-bar height for safety */
    }
    #game-canvas {
      width: 98vw;
      max-width: 700px;
      height: 70vh;
      max-height: 650px;
      display: block;
      background: transparent;
      border: 6px solid #7fd7f8;
      border-radius: 30px;
      box-shadow: 0 0 48px #b7aaf7b9, 0 0 18px #1a2237;
      margin-bottom: 18px;
      margin-top: 58px; /* Extra space above board */
    }
    /* --- INSTRUCTIONS MODAL --- */
    #instructions {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(24, 28, 50, 0.99);
      display: none;
      align-items: center; justify-content: center;
      z-index: 2000;
      text-align: center;
      flex-direction: column;
      animation: fadeIn 0.7s;
      overflow: auto;
    }
    #instructions.visible { display: flex; }
    #instructions-content {
      background: rgba(30,38,58,0.98);
      border-radius: 34px;
      padding: 46px 7vw 22px 7vw;
      box-shadow: 0 8px 48px #7fd7f8e0, 0 0 0 2px #b7aaf711;
      border: 4px solid #7fd7f8;
      max-width: 99vw;
      min-width: 200px;
      min-height: 80px;
      animation: popIn 0.48s cubic-bezier(.32,1.56,.53,.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      justify-content: center;
    }
    #instructions-logo {
      max-width: 330px;
      width: 44vw;
      min-width: 120px;
      margin-bottom: 30px;
      border-radius: 34px;
      box-shadow: 0 0 44px #7fd7f8bb, 0 0 12px #ffe24b;
      background: rgba(255,255,255,0.99);
      padding: 18px 36px;
      animation: logoGlow 2.7s infinite alternate;
      object-fit: contain;
      display: block;
    }
    #instructions .modal-header {
      font-family: Orbitron, Manrope, Arial, sans-serif;
      font-size: 1.55em;
      color: #ffe24b;
      letter-spacing: 1.2px;
      font-weight: 900;
      text-shadow: 0 0 22px #ffe24b66, 0 0 5px #7fd7f8, 0 0 1px #fff;
      margin-bottom: 16px;
      margin-top: 0px;
      line-height: 1.08;
    }
    #instructions .quick-steps {
      display: flex;
      flex-direction: row;
      gap: 32px;
      justify-content: center;
      align-items: flex-start;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    #instructions .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 35px;
      max-width: 75px;
      gap: 7px;
      font-size: 1.18em;
      color: #e7fafd;
      font-weight: 700;
    }
    #instructions .step-icon {
      font-size: 1.8em;
      text-shadow: 0 0 9px #7fd7f8, 0 0 4px #ffe24b;
      margin-bottom: 2px;
    }
    #instructions .input-hint {
      margin-top: 18px;
      color: #b7aaf7;
      font-size: 1.18em;
      letter-spacing: 0.4px;
      opacity: 0.98;
      text-shadow: 0 0 3px #7fd7f866;
    }
    #instructions .modal-btn {
      margin-top: 25px;
      font-size: 1.19em;
      padding: 16px 62px;
      border-radius: 24px;
      border: none;
      background: linear-gradient(90deg,#7fd7f8 40%, #ffe24b 100%);
      color: #1d2438;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 8px 22px #7fd7f8bb, 0 2px 12px #b7aaf7aa;
      transition: 0.17s;
      font-family: 'Orbitron', 'Manrope', Arial, sans-serif;
      letter-spacing: 1px;
      animation: pulseBtn 1.2s infinite alternate;
    }
    #instructions .modal-btn:hover {
      background: linear-gradient(90deg, #ffe24b, #7fd7f8);
      color: #000;
      transform: scale(1.05);
    }
    #instructions .credit {
      margin-top: 18px;
      font-size: 1.1em;
      color: #7fd7f8bb;
      opacity: 0.93;
      letter-spacing: 1.2px;
    }
    #instructions .close-x {
      position: absolute;
      right: 28px;
      top: 28px;
      font-size: 1.8em;
      color: #b7aaf7;
      background: none;
      border: none;
      cursor: pointer;
      opacity: 0.7;
      padding: 0 7px;
      transition: color 0.13s, opacity 0.13s;
      z-index: 3;
      font-family: inherit;
    }
    #instructions .close-x:hover { color: #ffe24b; opacity: 1; }
    /* --- END INSTRUCTIONS --- */
    #gameover-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(23,29,55,0.97);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      animation: fadeIn 0.6s;
    }
    #gameover-modal.visible { display: flex; }
    #gameover-content {
      background: rgba(32,38,56,0.99);
      border-radius: 32px;
      padding: 38px 26px 26px 26px;
      box-shadow: 0 8px 44px #7fd7f8cc;
      border: 4px solid #7fd7f8;
      max-width: 99vw;
      animation: popIn 0.4s cubic-bezier(.32,1.56,.53,.92);
      text-align: center;
    }
    #gameover-content h2 {
      color: #ffe24b;
      font-size: 1.32em;
      margin-bottom:0.2em;
      text-shadow: 0 0 16px #ffe24b, 0 0 6px #fff3;
      font-family: Orbitron, Manrope, Arial, sans-serif;
    }
    #gameover-content .final-score {
      font-size: 1.23em;
      color: #fff;
      margin: 0.4em 0 0.1em 0;
      text-shadow: 0 0 14px #7fd7f8b0;
    }
    #gameover-content .highscore {
      font-size: 1.09em;
      margin-bottom: 1em;
      color: #7fd7f8;
      text-shadow: 0 0 12px #b7aaf7;
    }
    #gameover-content button {
      margin-top: 11px;
      font-size: 1.18em;
      padding: 13px 50px;
      border-radius: 17px;
      border: none;
      background: linear-gradient(90deg,#7fd7f8,#ffe24b);
      color: #1d2438;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 13px #7fd7f8c9;
      transition: 0.12s;
    }
    #gameover-content button:hover {
      background: #ffe24b;
      color: #222;
    }
    @keyframes fadeIn {
      from { opacity:0 }
      to { opacity:1 }
    }
    @keyframes popIn {
      0%   { transform: scale(0.92);}
      100% { transform: scale(1);}
    }
    @media (max-width: 800px) {
      #top-bar { min-height: 80px; height: 80px; gap: 10px;}
      #logo-img { height: 48px; padding: 5px 8px;}
      #score-bar { font-size: 1em; padding: 6px 10px;}
      #instructions-logo { max-width: 120px; padding: 5px 10px;}
      #game-container { padding-top: 90px; }
      #game-canvas { margin-top: 10px; }
      #instructions-content { padding: 10px 3vw 8px 3vw;}
    }
  </style>
</head>
<body>
  <div id="top-bar">
    <img src="img/logo.png" id="logo-img" alt="BenBlinko" />
    <div id="score-bar">
      <span class="score"><b>🏆</b> <span id="score-val">0</span></span>
      <span class="score"><b>⭐</b> <span id="highscore-val">0</span></span>
      <span class="score"><b>🔴</b> <span id="ball-val">1/5</span></span>
      <span id="multiplier-box" class="score inactive">
        <span id="multi-x">x2</span><span class="bonus-label inactive">COMBO</span>
      </span>
      <button id="help-btn">❔</button>
    </div>
  </div>
  <div id="game-container">
    <canvas id="game-canvas"></canvas>
  </div>
  <!-- MODERN INSTRUCTIONS MODAL WITH LARGE LOGO -->
  <div id="instructions">
    <div id="instructions-content">
      <img src="img/logo.png" id="instructions-logo" alt="BenBlinko Logo" />
      <button class="close-x" id="close-instructions-x" title="Close">&times;</button>
      <div class="modal-header">Welcome to BenBlinko!</div>
      <div class="quick-steps">
        <div class="step"><span class="step-icon">↔️</span><span>Steer</span></div>
        <div class="step"><span class="step-icon">💥</span><span>Bounce</span></div>
        <div class="step"><span class="step-icon">🌟</span><span>Combo</span></div>
        <div class="step"><span class="step-icon">🏁</span><span>Score</span></div>
      </div>
      <div class="input-hint" id="input-hint"></div>
      <button class="modal-btn" id="close-instructions-btn">Start!</button>
      <div class="credit">BenBlinko &copy; 2025</div>
    </div>
  </div>
  <div id="gameover-modal">
    <div id="gameover-content">
      <h2>Game Over!</h2>
      <div class="final-score">Score: <span id="final-score-val">0</span></div>
      <div class="highscore">High Score: <span id="highscore-final">0</span></div>
      <button id="play-again-btn">Play Again</button>
    </div>
  </div>
  <script>
    // Responsive input hint for instructions
    function updateInputHint() {
      const hint = document.getElementById('input-hint');
      if (window.innerWidth < 800 && ('ontouchstart' in window)) {
        hint.textContent = "Tip: Tilt your device or tap left/right to steer!";
      } else {
        hint.textContent = "Tip: Use ←/→ or A/D keys to steer the ball.";
      }
    }
    window.addEventListener('resize', updateInputHint);
    window.addEventListener('DOMContentLoaded', updateInputHint);

    // Show instructions automatically on first load
    function showInstructions() { document.getElementById('instructions').classList.add('visible'); }
    function hideInstructions() { document.getElementById('instructions').classList.remove('visible'); }
    document.getElementById('help-btn').onclick = showInstructions;
    document.getElementById('close-instructions-x').onclick = hideInstructions;
    document.getElementById('close-instructions-btn').onclick = function() {
      hideInstructions();
      gameStart();
    };
    window.addEventListener('DOMContentLoaded', showInstructions);

    // Game canvas and responsive
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() {
      const topBar = document.getElementById('top-bar');
      const barHeight = topBar.offsetHeight;
      const H = window.innerHeight - barHeight - 50;
      const W = window.innerWidth;
      let w = W, h = H;
      if (w / h > 9/16) w = h * 9/16;
      else h = w * 16/9;
      canvas.width = w;
      canvas.height = h;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Game elements scale
    let tilt = 0, tiltReady = false;
    let score = 0, highscore = 0, ballsLeft = 5, ballNum = 1;
    let comboActive = false, comboMultiplier = 1, comboPegIdxs = [];
    let flyups = [];
    document.getElementById('score-val').textContent = score;
    document.getElementById('highscore-val').textContent = highscore;
    document.getElementById('ball-val').textContent = `${ballNum}/5`;

    function getBoardSpec() {
      const w = canvas.width, h = canvas.height;
      const boardMarginX = w*0.045, boardMarginY = h*0.04;
      const boardW = w - 2*boardMarginX;
      const boardH = h - 2*boardMarginY - h*0.13;
      const slotCount = 7;
      const pegRows = 10;
      const pegCols = 10;
      const pegRadius = boardW*0.012;
      const ballRadius = boardW*0.022;
      const slotH = boardH*0.12;
      return {
        x: boardMarginX,
        y: boardMarginY,
        w: boardW,
        h: boardH,
        slotCount,
        pegRows,
        pegCols,
        pegRadius,
        ballRadius,
        slotH
      };
    }
    function getSlots(spec) {
      const widths = [1,1,1,0.7,1,1,1];
      const total = widths.reduce((a,b) => a+b,0);
      let pos = spec.x;
      return Array.from({length: spec.slotCount}, (_, i) => {
        let w = spec.w * widths[i]/total;
        let slot = {
          x: pos,
          w: w,
          reward: [10,40,120,400,120,40,10][i],
          color: [
            "#7fd7f8", "#b7aaf7", "#8dd6e8", "#ffe24b",
            "#8dd6e8", "#b7aaf7", "#7fd7f8"
          ][i]
        };
        pos += w;
        return slot;
      });
    }
    function getPegs(spec) {
      let pegs = [];
      for (let row = 0; row < spec.pegRows; row++) {
        for (let col = 0; col < spec.pegCols; col++) {
          let xOffset = (row%2 ? (spec.w/spec.pegCols)/2 : 0);
          let px = spec.x + col*(spec.w/spec.pegCols) + xOffset;
          let py = spec.y + row*((spec.h-spec.slotH*1.15)/spec.pegRows) + spec.pegRadius*1.7;
          pegs.push({x: px, y: py, sparkle: 0, color: "#fff", combo: false, pulse: 0});
        }
      }
      return pegs;
    }

    // Ball, Trail, Confetti
    let ball = null, ballTrail = [],
        slots = [], pegs = [], spec = getBoardSpec();
    let lastX = 0, xSameCount = 0;

    function randomComboPegs() {
      let count = 3 + Math.floor(Math.random()*2);
      let idxs = [];
      while (idxs.length < count) {
        let idx = Math.floor(Math.random()*pegs.length);
        if (!idxs.includes(idx) && !isPegEdge(idx)) idxs.push(idx);
      }
      comboPegIdxs = idxs;
      comboMultiplier = [2,3,4][count-3];
      comboActive = false;
      pegs.forEach((p,i) => p.combo = idxs.includes(i));
      updateMultiplierUI();
    }
    function isPegEdge(idx) {
      let p = pegs[idx];
      return p.x < spec.x + spec.w*0.13 || p.x > spec.x + spec.w*0.87;
    }
    function updateMultiplierUI() {
      let mb = document.getElementById('multiplier-box');
      let mx = document.getElementById('multi-x');
      let label = mb.querySelector('.bonus-label');
      mb.classList.remove('inactive');
      if (!comboActive) {
        mb.classList.add('inactive');
        mx.textContent = `x${comboMultiplier}`;
        if (!label) {
          mb.insertAdjacentHTML('beforeend','<span class="bonus-label inactive">COMBO</span>');
        } else {
          label.textContent = "COMBO";
          label.classList.add('inactive');
        }
      } else {
        mx.textContent = `x${comboMultiplier}`;
        if (!label) {
          mb.insertAdjacentHTML('beforeend','<span class="bonus-label">COMBO!</span>');
        } else {
          label.textContent = "COMBO!";
          label.classList.remove('inactive');
        }
      }
    }
    function animateScore(id) {
      let el = document.getElementById(id);
      el.classList.add('animated');
      setTimeout(()=>el.classList.remove('animated'), 400);
    }
    function spawnBall() {
      spec = getBoardSpec();
      slots = getSlots(spec);
      pegs = getPegs(spec);
      ball = {
        x: spec.x + spec.w/2,
        y: spec.y + spec.ballRadius,
        r: spec.ballRadius,
        vx: 0,
        vy: 0,
        hue: Math.floor(Math.random()*360),
        stopped: false,
        slotIdx: -1,
        confetti: []
      };
      ballTrail = [];
      lastX = ball.x;
      xSameCount = 0;
      randomComboPegs();
      document.getElementById('ball-val').textContent = `${ballNum}/5`;
      updateMultiplierUI();
    }

    function update() {
      if (!ball || ball.stopped) return;
      // SLOWEST gravity and side movement for relaxed gameplay
      ball.vy += spec.h * 0.000022; // SLOWEST gravity yet
      ball.vx += tilt * 0.004;      // SLOWEST left/right response
      if (ball.y > spec.y + spec.h * 0.6) {
        let c = spec.x + spec.w/2;
        ball.vx += (c-ball.x) * 0.000012;
      }
      ball.x += ball.vx;
      ball.y += ball.vy;
      ball.hue = (ball.hue + 2) % 360;
      ball.vx *= 0.99; // SLOWEST decay

      ballTrail.unshift({x: ball.x, y: ball.y, hue: ball.hue});
      if (ballTrail.length > 60) ballTrail.pop();

      if (ball.x - ball.r < spec.x) {
        ball.x = spec.x + ball.r + 0.2;
        ball.vx = Math.abs(ball.vx)*0.5 + 0.3*Math.random(); // SLOWEST wall bounce
      }
      if (ball.x + ball.r > spec.x + spec.w) {
        ball.x = spec.x + spec.w - ball.r - 0.2;
        ball.vx = -Math.abs(ball.vx)*0.5 - 0.3*Math.random();
      }

      pegs.forEach((p, i) => {
        const dx = ball.x - p.x;
        const dy = ball.y - p.y;
        const dist = Math.hypot(dx, dy);
        if (dist < ball.r + spec.pegRadius) {
          const angle = Math.atan2(dy, dx);
          const overlap = ball.r + spec.pegRadius - dist + 0.8;
          ball.x += Math.cos(angle) * overlap;
          ball.y += Math.sin(angle) * overlap;
          const nudge = (Math.random()-0.5)*0.6;
          ball.vx = Math.cos(angle + Math.PI/2) * 0.55 + nudge; // SLOWEST peg bounce
          ball.vy *= 0.95 + (Math.random()-0.5)*0.05;
          if (ball.x < spec.x + spec.w*0.16) ball.vx += 0.2 + Math.random()*0.1;
          if (ball.x > spec.x + spec.w*0.84) ball.vx -= 0.2 + Math.random()*0.1;
          p.sparkle = 1.0;
          p.pulse = 1.0;
          if (p.combo && !comboActive) {
            comboActive = true;
            updateMultiplierUI();
            if (Math.random() < 0.12 && ballNum < 5) {
              ballsLeft += 1;
              flyups.push({x: ball.x, y: ball.y-8, text:"+ BALL!", color:"#ff89aa", life:32, vy:-1.1});
            }
            flyups.push({x: ball.x, y: ball.y-10, text:`x${comboMultiplier} COMBO!`, color:"#ffe24b", life:38, vy:-1.5});
          }
        }
        p.sparkle *= 0.93;
        p.pulse *= 0.92;
      });

      if (Math.abs(ball.x - lastX) < 0.6) xSameCount++;
      else xSameCount = 0;
      lastX = ball.x;
      if (xSameCount > 10) {
        if (ball.x < spec.x + spec.w/2) ball.vx += 0.6+Math.random();
        else ball.vx -= 0.6+Math.random();
        xSameCount = 0;
      }

      if (ball.y + ball.r >= spec.y + spec.h - spec.slotH) {
        ball.stopped = true;
        const idx = slots.findIndex(s => ball.x > s.x && ball.x < s.x + s.w);
        if (idx !== -1) {
          ball.x = slots[idx].x + slots[idx].w / 2;
          let addScore = slots[idx].reward * (comboActive ? comboMultiplier : 1);
          score += addScore;
          flyups.push({x:ball.x, y:spec.y+spec.h-spec.slotH-12, text:`+${addScore}`, color:comboActive?"#ffe24b":slots[idx].color, life:44, vy:-1.6});
          animateScore('score-bar');
          if (score > highscore) {
            highscore = score;
            animateScore('score-bar');
            document.getElementById('highscore-val').textContent = highscore;
            localStorage.setItem('blinkoHighScore', highscore);
          }
          document.getElementById('score-val').textContent = score;
          ball.slotIdx = idx;
          for (let i=0; i<28; ++i) {
            ball.confetti.push({
              x: ball.x,
              y: spec.y + spec.h - spec.slotH,
              vx: Math.cos(i/28*2*Math.PI)* (1.4+Math.random()*1.8) * (spec.w/350),
              vy: -2.2 - Math.random()*2.2 * (spec.h/540),
              color: slots[idx].color,
              t: 0
            });
          }
        }
        setTimeout(() => {
          if (ballNum < ballsLeft) {
            ballNum++;
            comboActive = false;
            updateMultiplierUI();
            spawnBall();
          } else {
            showGameOver();
          }
        }, 900);
      }

      if (ball && ball.confetti) {
        for (let c of ball.confetti) {
          c.x += c.vx;
          c.y += c.vy;
          c.vy += spec.h*0.00013;
          c.t += 1;
        }
        ball.confetti = ball.confetti.filter(c => c.y < canvas.height && c.t < 80);
      }
      for (let f of flyups) {
        f.y += f.vy;
        f.life -= 1;
      }
      flyups = flyups.filter(f=>f.life>0);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      slots.forEach((s, i) => {
        ctx.save();
        let pulse = (ball && ball.stopped && ball.slotIdx === i) || i===3 ? (1+Math.sin(performance.now()/80))/2 : 0;
        ctx.fillStyle = s.color;
        ctx.shadowColor = "#fff";
        ctx.shadowBlur = i===3 ? 30+18*pulse : 22*pulse;
        ctx.fillRect(s.x, spec.y + spec.h - spec.slotH, s.w, spec.slotH);
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 0.16;
        ctx.fillStyle = '#000';
        ctx.fillRect(s.x, spec.y + spec.h - spec.slotH - 8, s.w, 8);
        ctx.globalAlpha = 1;
        ctx.font = `bold ${Math.round(spec.slotH*0.29)}px Orbitron, monospace`;
        ctx.fillStyle = '#223d54';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = "#fff";
        ctx.shadowBlur = 8;
        ctx.fillText(s.reward, s.x + s.w / 2, spec.y + spec.h - spec.slotH/2);
        ctx.restore();
      });
      pegs.forEach((p, i) => {
        ctx.save();
        let color = "#fff";
        let radius = spec.pegRadius;
        let alpha = 0.93;
        if (p.combo) {
          color = "#ffe24b";
          radius = spec.pegRadius * (1.21 + 0.09*Math.sin(performance.now()/120 + i)) * (1+p.pulse*0.6);
          alpha = 0.93 + 0.14 * Math.abs(Math.sin(performance.now()/160 + i));
        }
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI*2);
        ctx.shadowColor = color;
        ctx.shadowBlur = p.combo ? 28 : 10;
        ctx.globalAlpha = alpha * (0.5 + 0.5*p.sparkle + p.pulse*0.5);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.restore();
        p.sparkle *= 0.93;
        p.pulse *= 0.95;
      });
      for (let i=ballTrail.length-1; i>0; i--) {
        let t = i/ballTrail.length;
        ctx.save();
        ctx.beginPath();
        ctx.arc(ballTrail[i].x, ballTrail[i].y, ball.r*(0.80+0.17*t), 0, Math.PI*2);
        ctx.globalAlpha = 0.12 + 0.21*t;
        ctx.fillStyle = `hsl(${ballTrail[i].hue},65%,${61+10*t}%)`;
        ctx.shadowColor = "#b7aaf7";
        ctx.shadowBlur = 14*t;
        ctx.fill();
        ctx.restore();
      }
      if (ball) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
        ctx.fillStyle = `hsl(${ball.hue},66%,74%)`;
        ctx.shadowColor = '#7fd7f8';
        ctx.shadowBlur = 35 + 18*Math.sin(performance.now()/130);
        ctx.globalAlpha = 0.99;
        ctx.fill();
        ctx.restore();
      }
      if (ball && ball.confetti) {
        for (let c of ball.confetti) {
          ctx.save();
          ctx.globalAlpha = Math.max(0, 1 - c.t/80);
          ctx.fillStyle = c.color;
          ctx.beginPath();
          ctx.arc(c.x, c.y, 2.1+Math.sin(c.t/3)*1.05, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }
      for (let f of flyups) {
        ctx.save();
        ctx.globalAlpha = Math.max(0,f.life/44);
        ctx.font = 'bold 1em Orbitron, monospace';
        ctx.fillStyle = f.color;
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.textAlign = "center";
        ctx.strokeText(f.text, f.x, f.y);
        ctx.fillText(f.text, f.x, f.y);
        ctx.restore();
      }
    }

    function loop() { update(); draw(); requestAnimationFrame(loop);}
    function initTilt() {
      if (window.DeviceOrientationEvent?.requestPermission) {
        DeviceOrientationEvent.requestPermission().then(p => {
          if (p === 'granted') {
            tiltReady = true;
            window.addEventListener('deviceorientation', onTilt);
          }
        });
      } else {
        window.addEventListener('deviceorientation', onTilt);
        tiltReady = true;
      }
    }
    function onTilt(e) { tilt = e.gamma || 0; }
    function gameStart() {
      document.getElementById('gameover-modal').classList.remove('visible');
      document.getElementById('instructions').classList.remove('visible');
      resizeCanvas();
      score = 0; ballNum = 1; ballsLeft = 5;
      comboActive = false;
      flyups = [];
      updateMultiplierUI();
      document.getElementById('score-val').textContent = score;
      document.getElementById('ball-val').textContent = `${ballNum}/5`;
      document.getElementById('highscore-val').textContent = localStorage.getItem('blinkoHighScore')||0;
      spawnBall();
      initTilt();
      requestAnimationFrame(loop);
    }

    function showGameOver() {
      document.getElementById('final-score-val').textContent = score;
      document.getElementById('highscore-final').textContent = localStorage.getItem('blinkoHighScore')||0;
      document.getElementById('gameover-modal').classList.add('visible');
    }
    document.getElementById('play-again-btn').onclick = gameStart;
    window.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') tilt -= 1.1;
      if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') tilt += 1.1;
      if (e.key === 'Escape') {
        hideInstructions();
        document.getElementById('gameover-modal').classList.remove('visible');
      }
    });
    canvas.addEventListener('touchstart', function(e) {
      if (!ball || ball.stopped) return;
      let rect = canvas.getBoundingClientRect();
      let x = e.touches[0].clientX - rect.left;
      if (x < canvas.width/2) tilt -= 1.6;
      else tilt += 1.6;
    });
    window.addEventListener('DOMContentLoaded', ()=>{
      highscore = parseInt(localStorage.getItem('blinkoHighScore')||'0')||0;
      document.getElementById('highscore-val').textContent = highscore;
    });
    window.addEventListener('resize', () => {
      resizeCanvas();
      spec = getBoardSpec();
      slots = getSlots(spec);
      pegs = getPegs(spec);
    });
    // Start the loop
    requestAnimationFrame(loop);
  </script>
</body>
</html>