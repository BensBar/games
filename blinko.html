<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BenBlinko ‚Ä¢ Neon Laser Deluxe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Manrope:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --neon-cyan: #38b6ff;
      --neon-yellow: #ffe24b;
      --neon-pink: #ff89aa;
      --neon-purple: #b7aaf7;
      --neon-green: #31ed8a;
      --glow: 0 0 24px var(--neon-cyan), 0 0 12px var(--neon-yellow), 0 0 16px var(--neon-pink);
      --radius: 2.4vw;
      --font-main: 'Manrope', Arial, sans-serif;
      --font-alt: 'Orbitron', 'Manrope', Arial, sans-serif;
      --canvas-max-width: 540px;
      --canvas-max-height: 98vh;
      --canvas-min-height: 320px;
    }
    html,body {
      margin:0;padding:0;
      height:100%;
      min-height:100vh;
      color:#fff;
      background: #0d1540;
      font-family:var(--font-main);
      box-sizing:border-box;
      overflow:hidden;
    }
    body {
      background: linear-gradient(120deg, #22284b 0 35%, #162044 60%, #1f3877 100%),
                  radial-gradient(ellipse at 50% 30%, #2bb7ff55 0%, #ffe24b33 68%, #01081a 100%);
      animation: laserbg 14s linear infinite alternate;
      min-height: 100vh;
      padding-bottom: env(safe-area-inset-bottom, 0);
      padding-top: env(safe-area-inset-top, 0);
    }
    @keyframes laserbg {
      0%{ background-position:0 0,50% 40%;}
      100%{ background-position:120px 200px,50% 55%;}
    }

    /* Overlay styles */
    #overlay, #gameover-overlay {
      position:fixed;z-index:1000;inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:rgba(12,18,38,0.98);
      opacity:1;transition:opacity 0.4s cubic-bezier(.46,.03,.52,.96);
      width:100vw;height:100vh;max-width:100vw;max-height:100vh;
      padding-bottom:env(safe-area-inset-bottom,0);
      padding-top:env(safe-area-inset-top,0);
    }
    #overlay.hide, #gameover-overlay.hide { opacity:0;pointer-events:none;}

    .neon-logo {
      width: clamp(160px, 45vw, 400px);
      margin-bottom: clamp(1.5vh, 4vw, 3vh);
      filter: drop-shadow(0 0 48px var(--neon-cyan)) drop-shadow(0 0 16px var(--neon-yellow));
      border-radius:var(--radius);
      border:2.5px solid var(--neon-yellow);
      background:linear-gradient(90deg,#ffe24b44 50%,#2bb7ff44 100%);
      box-shadow: 0 0 26px #ffe24b44, 0 0 18px #38b6ff44;
      user-select:none;
      transition: box-shadow 0.2s;
      animation: pulse 2.1s infinite alternate cubic-bezier(0.68,-0.55,0.27,1.55);
    }
    @keyframes pulse { 0%{transform:scale(1);} 100%{transform:scale(1.045);} }

    #tap-to-start {
      font-family:var(--font-alt);
      font-size: clamp(1.5em, 6vw, 2.5em);
      background:linear-gradient(90deg,#38b6ff 0,#ffe24b 80%,#ff89aa 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      letter-spacing: 0.16em;
      filter: drop-shadow(0 0 16px var(--neon-cyan));
      margin-bottom: 2vh;
      animation:blinker 1.1s infinite alternate;
      font-weight: 900;
      text-shadow: 0 3px 16px #000;
      user-select:none;
      border-radius: 1vw;
    }
    @keyframes blinker { 0%{opacity:1;} 100%{opacity:0.55;} }

    #enable-tilt-btn {
      display:none;
      font-size:clamp(1em,4vw,1.3em);padding:1vw 7vw;margin:3vh auto 0 auto;
      background:linear-gradient(90deg,#38b6ff 0,#ffe24b 100%);
      color:#080c1c;font-family:var(--font-alt);
      border:none;border-radius:2em;box-shadow:0 0 24px #ffe24b99,0 2px 8px #38b6ff33;
      font-weight:bold;letter-spacing:0.09em;
      cursor:pointer;outline:2px solid #fff5;
      filter:drop-shadow(0 0 12px #ffe24b88);
      transition:background 0.15s, color 0.1s, transform 0.1s;
    }
    #enable-tilt-btn:hover {
      background:linear-gradient(90deg,#ffe24b 0,#38b6ff 100%);
      color:#222;transform:scale(1.04);
    }
    #credit { color:#fff9;font-size:clamp(1em,2.1vw,1.4em);margin-top:2vh;letter-spacing:2.2px;font-family:var(--font-main);text-shadow:0 0 10px #2bb7ff33;user-select:none;text-align:center; }

    #help-btn {
      position:absolute;top:3vw;right:4vw;z-index:2;
      background:linear-gradient(90deg,#38b6ff 30%,#ffe24b 100%);
      color:#181a2d;border:none;
      font-family:var(--font-alt);font-weight:bold;
      padding:10px 26px;border-radius:14px;font-size:1.1em;
      cursor:pointer;box-shadow:0 4px 18px #2bb7ff33;
      transition:background 0.18s, color 0.18s, transform 0.14s;
    }
    #help-btn:hover {background:linear-gradient(90deg,#ffe24b 30%,#38b6ff 100%);color:#0a1a2f;transform:scale(1.06);}

    #game-canvas {
      display:block;
      margin:0 auto;
      max-width: var(--canvas-max-width);
      max-height: var(--canvas-max-height);
      min-height: var(--canvas-min-height);
      width: 98vw;
      height: auto;
      aspect-ratio: 9 / 14;
      background: radial-gradient(ellipse at 50% 35%,#24396a 60%,#ffe24b 140%);
      border-radius: 2vw;
      box-shadow: 0 8px 44px #ffe24b44,0 4px 24px #38b6ff44;
      border: 3px solid var(--neon-yellow);
      outline: none;
      touch-action: none;
      z-index: 1;
      transition: box-shadow 0.2s;
      margin-bottom: 1.6vh;
    }

    #bottom-bar {
      position:fixed;bottom:0;left:0;width:100vw;
      background:rgba(15,28,61,0.97);
      border-top-left-radius:24px;border-top-right-radius:24px;
      box-shadow:0 -8px 36px #ffe24bbb inset,0 -2px 12px #2bb7ff99;
      padding:0.7em 0;display:flex;justify-content:center;align-items:center;
      z-index:10;flex-wrap:wrap;backdrop-filter:blur(3.5px);
      min-height: 62px;
      gap: 2vw;
    }
    #score-bar {
      display:flex;align-items:center;gap:1.7em;font-size:1.25em;flex-wrap:wrap;justify-content:center;
      filter:drop-shadow(0 0 8px #2bb7ffcc);
      user-select: none;
    }
    .score {
      background:linear-gradient(90deg,#fff9 60%, var(--neon-yellow) 100%);
      padding:0.46em 1.2em;border-radius:1.2em;border:2px solid var(--neon-cyan);
      font-weight:bold;color:#24396a;text-shadow:0 0 7px var(--neon-cyan),0 0 1px #fff9;
      letter-spacing:1.5px;font-family:var(--font-alt);
      font-size:1em;min-width:52px;text-align:center;display:inline-block;
      box-shadow:0 2px 16px #2bb7ff55;margin:0 2px;transition:background 0.2s,border 0.2s;
      position:relative;overflow:hidden;
    }
    .score:before {
      content:"";position:absolute;left:0;top:0;width:100%;height:100%;
      background:linear-gradient(120deg,#fff6 0 70%,var(--neon-yellow) 100%);
      opacity:0.19;pointer-events:none;
      border-radius:inherit;z-index:0;
    }
    #multiplier-box {
      min-width:72px;background:linear-gradient(90deg,var(--neon-yellow) 44%,var(--neon-pink) 100%);
      border:2px solid var(--neon-yellow);font-weight:bold;font-size:1em;display:flex;
      align-items:center;justify-content:center;letter-spacing:1px;gap:0;
      box-shadow:0 0 16px var(--neon-yellow),0 0 8px var(--neon-pink);
      color:#111;text-shadow:1px 1px 0 #fff,2px 2px 2px #000,0 0 8px var(--neon-yellow);
      position:relative;overflow:hidden;
    }
    #multiplier-box:after {
      content:"";
      position:absolute;left:-40%;top:-100%;width:180%;height:200%;
      background:linear-gradient(110deg,#fff9 12%,var(--neon-yellow) 44%,var(--neon-pink) 70%,#fff0 100%);
      opacity:0.22;pointer-events:none;z-index:1;
      transform:rotate(-18deg);
      animation:laserstripe 2.7s linear infinite;
    }
    @keyframes laserstripe { 0%{top:-100%;} 100%{top:0%;} }
    #multiplier-box.inactive {
      background:linear-gradient(90deg,#fff9 80%,var(--neon-purple) 100%);
      border:2px solid var(--neon-purple);opacity:0.83;box-shadow:none;color:#555;
      text-shadow:1px 1px 0 #fff,2px 2px 2px #000,0 0 8px var(--neon-purple);
    }
    #multiplier-box .bonus-label {margin-left:8px;font-size:1em;opacity:0.93;font-weight:900;white-space:nowrap;color:#111;text-shadow:1px 1px 4px #fff,2px 2px 4px #000,0 0 4px var(--neon-yellow); font-family:var(--font-alt);}
    #multiplier-box .bonus-label.inactive { color: #555; opacity: 0.6; text-shadow: 1px 1px 4px #fff,2px 2px 4px #000,0 0 4px var(--neon-purple); }
    .animated { animation: bounce 0.5s cubic-bezier(.68,-0.55,.27,1.55);}
    @keyframes bounce { 0% { transform: scale(1);} 40% { transform: scale(1.3);} 60% { transform: scale(0.95);} 80% { transform: scale(1.13);} 100% { transform: scale(1);} }

    #slots-row {
      position: absolute; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-evenly;
      z-index: 3; pointer-events: none; height: 16%; min-height: 46px; max-height: 100px;
      gap: 0.7vw;
    }
    .slot-box {
      height:100%;
      width: clamp(44px,12vw,98px);
      font-size:1.4em;
      background:linear-gradient(180deg, #fff9 60%, var(--neon-yellow) 100%);
      border-radius:0 0 26px 26px;
      border:3px solid var(--neon-cyan);
      box-shadow:0 6px 32px var(--neon-cyan),0 0 32px var(--neon-yellow);
      display:flex;flex-direction:column;align-items:center;justify-content:flex-end;position:relative;margin:0 3px;
      filter:drop-shadow(0 0 16px var(--neon-yellow));
      overflow:hidden;
      transition: box-shadow 0.17s, border-color 0.17s;
    }
    .slot-value {
      font-family:var(--font-alt);
      font-size:1.2em;font-weight:bold;color:#111;
      text-shadow:2px 2px 10px #fff, 1px 1px 4px #000, 0 0 16px var(--neon-yellow);
      margin-bottom:10px;user-select:none;text-align:center;width:100%;display:block;letter-spacing:1px;
      filter:drop-shadow(0 0 5px var(--neon-yellow));
    }
    .slot-box.active {
      background:linear-gradient(180deg, var(--neon-yellow) 80%, var(--neon-pink) 100%);
      box-shadow:0 0 60px var(--neon-yellow),0 0 34px var(--neon-pink);
      filter:brightness(1.3) drop-shadow(0 0 27px var(--neon-yellow));
      border-color:var(--neon-pink);
    }

    #gameover-overlay {
      background:rgba(20,40,80,0.98);flex-direction:column;align-items:center;justify-content:center;
      text-align:center;display:flex;opacity:1;z-index:200;transition:opacity 0.7s;
      padding-bottom: env(safe-area-inset-bottom, 0);
      padding-top: env(safe-area-inset-top, 0);
    }
    #gameover-title {
      font-family:var(--font-alt);font-size:2.2em;color:var(--neon-yellow);
      text-shadow:0 4px 34px var(--neon-cyan),0 2px 8px #000a;
      margin-bottom:1.2em;letter-spacing:2.2px;filter:drop-shadow(0 0 8px var(--neon-pink));
    }
    #final-score {
      font-family:var(--font-alt);font-size:1.4em;color:#fff;
      margin-bottom:2em;letter-spacing:1px;filter:drop-shadow(0 0 8px var(--neon-cyan));
    }
    #play-again-btn {
      font-family:var(--font-alt);font-size:1.3em;
      background:linear-gradient(90deg,var(--neon-yellow) 44%,var(--neon-cyan) 100%);
      color:#232;border:none;border-radius:18px;padding:16px 32px;
      box-shadow:0 4px 28px var(--neon-cyan);cursor:pointer;margin-top:14px;font-weight:bold;letter-spacing:2px;
      transition:background 0.18s, color 0.12s, transform 0.13s;
    }
    #play-again-btn:hover {
      background:linear-gradient(90deg,var(--neon-cyan) 20%,var(--neon-yellow) 100%);
      color:#0a1a2f;transform:scale(1.03);
    }

    /* Responsive tweaks */
    @media (max-width: 700px) {
      #logo-entrance, .neon-logo { width: 70vw; }
      #game-canvas { max-width: 99vw; }
      #slots-row { height: 11vh; }
      .slot-box { width: 13vw; }
    }
    @media (max-width: 470px) {
      #game-canvas { min-height: 220px; }
      .score { font-size: 0.98em; min-width: 38px; }
    }
  </style>
</head>
<body>
  <audio id="intro-audio" src="/sounds/intro.mp3"></audio>
  <audio id="game-audio" src="/sounds/gameplay.mp3" loop></audio>
  <audio id="end-audio" src="/sounds/end.mp3"></audio>
  <div id="overlay">
    <img src="https://raw.githubusercontent.com/BensBar/games/main/img/logo.png" class="neon-logo" alt="BenBlinko Logo">
    <div id="tap-to-start">Tap or Press Space to Start</div>
    <button id="enable-tilt-btn" type="button">Enable Tilt Control</button>
    <div id="credit">by BensBar</div>
    <button id="help-btn" type="button">Help</button>
  </div>
  <div id="gameover-overlay" class="hide">
    <div id="gameover-title">Game Over</div>
    <div id="final-score"></div>
    <button id="play-again-btn">Play Again</button>
  </div>
  <div style="position:relative;max-width:var(--canvas-max-width);margin:0 auto;">
    <canvas id="game-canvas" tabindex="1"></canvas>
    <div id="slots-row"></div>
  </div>
  <div id="bottom-bar">
    <div id="score-bar">
      <span class="score"><b>üèÜ</b> <span id="score-val">0</span></span>
      <span class="score"><b>‚≠ê</b> <span id="highscore-val">0</span></span>
      <span class="score"><b>üî¥</b> <span id="ball-val">1/5</span></span>
      <span id="multiplier-box" class="score inactive">
        <span id="multi-x">x2</span><span class="bonus-label inactive">COMBO</span>
      </span>
    </div>
  </div>
  <script>
    // --- Responsive Canvas ---
    let BALL_START_Y, slotsHeight, boardPadding, PEG_RADIUS, BALL_RADIUS;
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');

    function setCanvasResolution() {
      // Use up to 98% of viewport width, max 540px, and up to 90% of viewport height for tall screens
      let vw = Math.min(window.innerWidth * 0.98, 540);
      let vh = Math.min(window.innerHeight * 0.90, vw * 1.4); // Allow up to 1.4:1 aspect for tall phones
      vh = Math.max(vh, 220); // Minimum height for playability

      const dpr = window.devicePixelRatio || 1;
      canvas.width = vw * dpr;
      canvas.height = vh * dpr;
      canvas.style.width = vw + 'px';
      canvas.style.height = vh + 'px';
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);
      recalcConstants();
      makePegs();
      drawSlots();
    }
    function recalcConstants() {
      BALL_START_Y = canvas.height * 0.06;
      slotsHeight = canvas.height * 0.155;
      boardPadding = canvas.height * 0.035;
      PEG_RADIUS = Math.max(8, canvas.width * 0.021);
      BALL_RADIUS = Math.max(12, canvas.width * 0.035);
    }

    window.addEventListener('DOMContentLoaded', setCanvasResolution);
    window.addEventListener('resize', setCanvasResolution);
    window.addEventListener('orientationchange', setCanvasResolution);

    // --- UI & Game Logic ---
    let gameStarted = false, gameOver = false, ballsThisGame = 7;
    const slotValues = [10, 50, 100, 200, 500, 200, 100, 50, 10];
    const slotColors = ["#38b6ff", "#ffef40", "#ff89aa", "#b7aaf7", "#31ed8a", "#b7aaf7", "#ff89aa", "#ffef40", "#38b6ff"];
    let ROWS = 14, COLS = slotValues.length, PEG_GAP = 0, PEG_Y_START = 0;
    let pegs = [], balls = [], confetti = [];
    let score = 0, highscore = 0, ballsLeft = ballsThisGame, multiplier = 2, comboActive = false, ballInPlay = false;
    let specialPegEvery = 3, tilt = 0, tiltRaw = 0, tiltHistory = [], TILT_HISTORY_SIZE = 6;
    function drawSlots(activeCol = -1) {
      const slotsRow = document.getElementById('slots-row');
      slotsRow.innerHTML = '';
      for (let i = 0; i < slotValues.length; ++i) {
        const slot = document.createElement('div');
        slot.className = 'slot-box' + (i === activeCol ? ' active' : '');
        slot.style.borderColor = slotColors[i];
        slot.innerHTML = `<span class="slot-value">${slotValues[i]}</span>`;
        slotsRow.appendChild(slot);
      }
    }
    function makePegs() {
      let rows = ROWS, cols = COLS;
      let drawWidth = canvas.width / (window.devicePixelRatio || 1), drawHeight = canvas.height / (window.devicePixelRatio || 1);
      let availableHeight = drawHeight - slotsHeight - boardPadding - BALL_RADIUS - 20;
      PEG_GAP = availableHeight / (rows-1); PEG_Y_START = BALL_START_Y + 10; pegs = [];
      let pegSpacing = drawWidth / cols;
      for (let row = 0; row < rows; ++row) {
        let y = PEG_Y_START + row * PEG_GAP, isOdd = row % 2 === 1;
        let pegsInRow = isOdd ? cols - 1 : cols, offset = isOdd ? pegSpacing / 2 : 0;
        for (let col = 0; col < pegsInRow; ++col) {
          let x = (col + 0.5) * pegSpacing + offset, isSpecial = (row % specialPegEvery === 0 && col % 2 === 1);
          pegs.push({x, y, hit: false, anim: 0, special: isSpecial});
        }
      }
    }
    function resetGame() {
      score = 0; ballsLeft = ballsThisGame; multiplier = 2; comboActive = false; ballInPlay = false;
      balls = []; confetti = []; gameOver = false;
      makePegs(); updateUI(); drawSlots(); setTimeout(()=>dropBall(), 600);
    }
    function updateUI() {
      document.getElementById('score-val').textContent = score;
      document.getElementById('highscore-val').textContent = highscore;
      document.getElementById('ball-val').textContent = ballsLeft + "/" + ballsThisGame;
      let mb = document.getElementById('multiplier-box'), mx = document.getElementById('multi-x'), label = mb.querySelector('.bonus-label');
      if (!comboActive) { mb.classList.add('inactive'); mx.textContent = `x${multiplier}`; label.textContent = "COMBO"; label.classList.add('inactive');
      } else { mb.classList.remove('inactive'); mx.textContent = `x${multiplier}`; label.textContent = "COMBO!"; label.classList.remove('inactive'); }
    }
    function animateScore(id) {
      let el = document.getElementById(id); if (!el) return;
      el.classList.add('animated'); setTimeout(()=>el.classList.remove('animated'), 500);
    }
    function dropBall(x = canvas.width/2) {
      if (ballsLeft <= 0 || ballInPlay || gameOver) return; ballInPlay = true; ballsLeft--;
      updateUI(); animateScore('ball-val');
      balls.push({ x: x, y: BALL_START_Y, vx: tilt * 1.6, vy: 0, radius: BALL_RADIUS, color: "#ffe24b", landed: false, slot: null });
    }
    function update() {
      if (gameOver) return; let landedThisFrame = false, landedCol = -1;
      for (let ball of balls) {
        if (ball.landed) continue;
        ball.vy += 0.00014 * canvas.height; ball.vx += tilt * 0.13;
        ball.x += ball.vx; ball.y += ball.vy;
        if (ball.x < ball.radius) { ball.x = ball.radius; ball.vx = -ball.vx * 0.44; }
        if (ball.x > canvas.width - ball.radius) { ball.x = canvas.width - ball.radius; ball.vx = -ball.vx * 0.44; }
        for (let i=0; i<pegs.length; ++i) {
          let peg = pegs[i], dx = ball.x - peg.x, dy = ball.y - peg.y, dist = Math.sqrt(dx*dx + dy*dy);
          if (dist < ball.radius + PEG_RADIUS && !peg.hit) {
            peg.hit = true; peg.anim = 1.0; ball.vy = -Math.abs(ball.vy) * 0.44; animateScore('score-val');
            let points = 10 * multiplier; if (peg.special) { points *= 4; showFloatingText("+BONUS!", peg.x, peg.y, "#ffe24b", "#ff89aa"); }
            score += points; comboActive = true; multiplier ++; animateScore('multiplier-box');
            for (let j=0;j<9;++j) {
              confetti.push({ x: peg.x, y: peg.y, vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*2,
                color: peg.special ? ['#ff89aa','#ffe24b','#38b6ff','#b7aaf7','#8dd6e8'][j%5] : ['#7fd7f8','#b7aaf7','#8dd6e8','#ffe24b','#ff89aa'][j%5], t: 0,
                shape: Math.random()<0.5?'circle':'star'
              });
            }
          }
        }
        if (ball.y > canvas.height - slotsHeight - ball.radius - 4) {
          let slotW = canvas.width / slotValues.length, col = Math.floor(ball.x / slotW);
          col = Math.max(0, Math.min(slotValues.length-1, col));
          ball.x = col * slotW + slotW/2; ball.y = canvas.height - slotsHeight - ball.radius;
          ball.vy = 0; ball.vx = 0; ball.landed = true; ball.slot = col; ballInPlay = false; landedThisFrame = true; landedCol = col;
          playEndAudio?.(); let slotScore = slotValues[col]; score += slotScore; animateScore('score-val');
          showFloatingText("+"+slotScore, ball.x, ball.y-18, slotColors[col], "#fff");
          for (let j=0;j<14;++j) {
            confetti.push({ x: ball.x, y: ball.y, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.8)*3,
              color: slotColors[col], t: 0, shape: "star" });
          }
          setTimeout(()=>{
            if (!comboActive) { multiplier = 2; animateScore('multiplier-box'); }
            comboActive = false; updateUI();
            if (ballsLeft > 0) setTimeout(()=>dropBall(), 480);
            else setTimeout(showGameOver, 600);
          }, 700);
        }
      }
      for (let peg of pegs) if (peg.anim>0) peg.anim -= 0.10;
      for (let c of confetti) { c.x += c.vx; c.y += c.vy; c.vy += 0.12; c.t++; }
      confetti = confetti.filter(c => c.t < 80);
      if (score > highscore) { highscore = score; animateScore('highscore-val'); }
      for (let i=floatingText.length-1; i>=0; --i) { let ft = floatingText[i]; ft.y -= 1.2, ft.opacity -= 0.016; if (ft.opacity <= 0) floatingText.splice(i,1);}
      drawSlots(landedThisFrame ? landedCol : -1);
    }
    function showFloatingText(txt, x, y, col1, col2) { floatingText.push({txt, x, y, opacity: 1, col1, col2}); }
    let floatingText = [];
    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      let grd = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
      grd.addColorStop(0, "#1d2e53");
      grd.addColorStop(1, "#2bb7ff");
      ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,canvas.height);
      for (let peg of pegs) {
        ctx.save(); ctx.beginPath();
        let r = PEG_RADIUS + (peg.anim>0 ? peg.anim*7 : 0);
        ctx.arc(peg.x, peg.y, r, 0, Math.PI*2);
        if (peg.special) { ctx.fillStyle = peg.hit ? "#ff89aa" : "#ffe24b"; ctx.shadowColor = "#ff89aa"; }
        else { ctx.fillStyle = peg.hit ? "#ffe24b" : "#2bb7ff"; ctx.shadowColor = "#2bb7ff"; }
        if (peg.anim>0) ctx.shadowBlur = 18*peg.anim;
        ctx.globalAlpha = peg.hit ? 0.93 : 0.75; ctx.fill(); ctx.restore();
      }
      for (let ball of balls) {
        ctx.save(); ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
        ctx.fillStyle = ball.color; ctx.shadowColor = "#fff"; ctx.shadowBlur = 16; ctx.globalAlpha = 0.98; ctx.fill(); ctx.restore();
      }
      for (let c of confetti) {
        ctx.save(); ctx.globalAlpha = Math.max(0, 1 - c.t/80); ctx.fillStyle = c.color;
        if (c.shape === "star") { drawStar(ctx, c.x, c.y, 5, 4, 2.2 + Math.sin(c.t/3) * 1.1); }
        else { ctx.beginPath(); ctx.arc(c.x, c.y, 2.1+Math.sin(c.t/3)*1.05, 0, Math.PI*2); ctx.fill(); }
        ctx.restore();
      }
      for (let ft of floatingText) {
        ctx.save(); ctx.globalAlpha = ft.opacity; ctx.font = "bold 22px Orbitron, sans-serif";
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 4;
        ctx.strokeText(ft.txt, ft.x-38, ft.y);
        ctx.fillStyle = ft.col1; ctx.fillText(ft.txt, ft.x-38, ft.y); ctx.restore();
      }
      drawTiltBar();
    }
    function drawTiltBar() {
      let barW = Math.max(80, canvas.width * 0.5), barH = 10;
      let cx = canvas.width/2, cy = canvas.height - 18;
      ctx.save(); ctx.globalAlpha = 0.22; ctx.fillStyle = '#fff'; ctx.beginPath();
      if (ctx.roundRect) { ctx.roundRect(cx-barW/2, cy-barH/2, barW, barH, 5);}
      else { ctx.rect(cx-barW/2, cy-barH/2, barW, barH);}
      ctx.fill(); ctx.globalAlpha = 0.7; ctx.fillStyle = '#2bb7ff';
      let tiltNorm = (tilt/2.2), markerX = cx + tiltNorm * (barW/2-7);
      ctx.beginPath(); ctx.arc(markerX, cy, 7, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1; ctx.font = 'bold 10px Orbitron, sans-serif'; ctx.fillStyle = '#172949'; ctx.textAlign = 'center'; ctx.fillText('TILT', cx, cy+3); ctx.restore();
    }
    function drawStar(ctx, x, y, points, outerRadius, innerRadius) {
      let angle = Math.PI / points; ctx.beginPath();
      for (let i = 0; i < 2 * points; i++) {
        let r = (i % 2 === 0) ? outerRadius : innerRadius;
        ctx.lineTo(x + Math.cos(i * angle) * r, y + Math.sin(i * angle) * r);
      } ctx.closePath(); ctx.fill();
    }
    function loop() {
      if (!('ontouchstart' in window) && !window.DeviceOrientationEvent) {
        if (tiltKey !== 0) { tilt += 0.13 * tiltKey; } else { tilt *= 0.85; }
        tilt = Math.max(-2.2, Math.min(2.2, tilt));
      }
      if (gameStarted && !gameOver) { update(); draw(); }
      requestAnimationFrame(loop);
    }
    canvas.addEventListener('pointerdown', function(e) {
      if (!gameStarted || gameOver) return;
      if (ballInPlay || ballsLeft <= 0) return;
      let rect = canvas.getBoundingClientRect();
      let x = (e.clientX - rect.left) * canvas.width / rect.width;
      dropBall(x);
    });
    let tiltKey = 0;
    window.addEventListener('keydown', e => {
      if (!gameStarted && (e.code=="Space"||e.code=="Enter")){ startGame(); }
      else if (gameStarted && !gameOver && (e.code=="Space"||e.code=="ArrowDown")) { dropBall(); }
      if (gameStarted && !gameOver) {
        if (e.code === "ArrowLeft" || e.code === "KeyA") { tiltKey = -1; }
        else if (e.code === "ArrowRight" || e.code === "KeyD") { tiltKey = 1; }
      }
      if (gameOver && (e.code=="Space"||e.code=="Enter")) playAgain();
    });
    window.addEventListener('keyup', e => {
      if (e.code === "ArrowLeft" || e.code === "KeyA" || e.code === "ArrowRight" || e.code === "KeyD") { tiltKey = 0; }
    });
    document.getElementById('help-btn').onclick = function(e) {
      e.stopPropagation();
      alert("BenBlinko Neon Laser Deluxe\n\nDrop the balls and hit pegs to score! The more pegs you hit in a row, the higher your combo multiplier. Hit special pegs for big bonuses!\n\nBalls land in the slots at the bottom for even more points.");
    };
    function startGame() {
      document.getElementById('overlay').classList.add('hide');
      gameStarted = true; playGameAudio?.(); resetGame(); setTimeout(()=>canvas.focus(), 300);
    }
    const overlay = document.getElementById('overlay');
    overlay.addEventListener('pointerdown', (e) => { startGame(); });
    overlay.addEventListener('click', (e) => { startGame(); });
    overlay.addEventListener('pointerdown', playIntroAudio);
    overlay.addEventListener('click', playIntroAudio);
    function showGameOver() {
      gameOver = true; stopGameAudio?.();
      let govl = document.getElementById('gameover-overlay');
      document.getElementById('final-score').innerHTML = `Score: <b>${score}</b><br>Highscore: <b>${highscore}</b>`;
      govl.classList.remove('hide');
    }
    function playAgain() {
      let govl = document.getElementById('gameover-overlay'); govl.classList.add('hide');
      gameStarted = true; playGameAudio?.(); resetGame();
    }
    document.getElementById('play-again-btn').onclick = playAgain;

    // TILT/ACCELEROMETER
    let tiltEnabled = false;
    function handleTilt(event) {
      if (!gameStarted || gameOver || !tiltEnabled) return;
      let gamma = event.gamma || 0, beta = event.beta || 0;
      let orientation = (screen.orientation && screen.orientation.angle) || window.orientation || 0;
      if (orientation === 90 || orientation === -90) gamma = -beta;
      tiltRaw = Math.max(-2.2, Math.min(2.2, gamma/9));
      tiltHistory.push(tiltRaw);
      if (tiltHistory.length > TILT_HISTORY_SIZE) tiltHistory.shift();
      tilt = tiltHistory.reduce((a,b)=>a+b,0) / tiltHistory.length;
    }
    function requestTiltPermission() {
      if (window.location.protocol !== "https:") {
        showTiltMessage('Tilt control requires HTTPS. Please use a secure connection.'); return;
      }
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(function(response) {
          if (response === 'granted') {
            tiltEnabled = true; window.addEventListener("deviceorientation", handleTilt, true);
            showTiltMessage('Tilt control enabled!'); document.getElementById('enable-tilt-btn').style.display = 'none';
          } else { showTiltMessage('Tilt permission denied.'); }
        }).catch(()=>showTiltMessage('Tilt permission error.'));
      } else if ('DeviceOrientationEvent' in window) {
        tiltEnabled = true; window.addEventListener("deviceorientation", handleTilt, true);
        showTiltMessage('Tilt control enabled!'); document.getElementById('enable-tilt-btn').style.display = 'none';
      } else { showTiltMessage('Tilt not supported on this device.'); }
    }
    function showTiltMessage(msg) {
      let el = document.getElementById('tilt-msg');
      if (!el) {
        el = document.createElement('div');
        el.id = 'tilt-msg';
        el.style.position = 'fixed';
        el.style.bottom = '80px';
        el.style.left = '50%';
        el.style.transform = 'translateX(-50%)';
        el.style.background = 'rgba(30,40,80,0.93)';
        el.style.color = '#ffe24b';
        el.style.padding = '12px 24px';
        el.style.borderRadius = '16px';
        el.style.fontFamily = "Orbitron, Manrope, Arial, sans-serif";
        el.style.fontSize = '1.1em';
        el.style.zIndex = 9999;
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display = 'none'; }, 3500);
    }
    function maybeShowTiltButton() {
      let isMobile = /android|iphone|ipad|ipod/i.test(navigator.userAgent);
      let enableTiltBtn = document.getElementById('enable-tilt-btn');
      if (isMobile && (window.DeviceOrientationEvent || 'ondeviceorientation' in window)) {
        enableTiltBtn.style.display = '';
      } else {
        enableTiltBtn.style.display = 'none';
      }
    }
    document.getElementById('enable-tilt-btn').onclick = requestTiltPermission;
    window.addEventListener('DOMContentLoaded', () => { maybeShowTiltButton(); });
    window.addEventListener('resize', maybeShowTiltButton);

    window.onload = () => { canvas.focus(); };
    makePegs(); updateUI(); drawSlots(); loop();

    // --- Audio (optional, fallback safe) ---
    function playIntroAudio(){try{document.getElementById('intro-audio')?.play();}catch{}}
    function playGameAudio(){try{document.getElementById('game-audio')?.play();}catch{}}
    function stopGameAudio(){try{let a=document.getElementById('game-audio');a&&a.pause();a&&a.currentTime&&(a.currentTime=0);}catch{}}
    function playEndAudio(){try{document.getElementById('end-audio')?.play();}catch{}}
  </script>
</body>
</html>
