<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BenBlinko</title>
  <meta name="viewport" content="width=480, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Manrope:wght@500;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      background: linear-gradient(120deg, #232f47 0%, #7fd7f8 100%);
      margin: 0;
      padding: 0;
      color: #222;
      font-family: 'Manrope', Arial, sans-serif;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
    }
    #top-bar {
      background: none;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100vw;
      margin: 0;
      padding: 0;
      z-index: 2;
    }
    #logo-img {
      height: 180px;
      width: auto;
      max-width: 72vw;
      background: rgba(255,255,255,0.97);
      border-radius: 36px;
      padding: 32px 52px;
      margin: 36px auto 6px auto;
      box-shadow: 0 2px 88px #7fd7f8ee, 0 0 32px #ffe24baa;
      filter: drop-shadow(0 2px 36px #7fd7f8cc);
      display: block;
      animation: logo-pulse 2.1s infinite cubic-bezier(.68,-0.55,.27,1.55) alternate;
      user-select: none;
      transition: height 0.4s, padding 0.4s, box-shadow 0.4s;
    }
    @keyframes logo-pulse {
      0% { box-shadow: 0 2px 88px #7fd7f8ee, 0 0 32px #ffe24baa; transform: scale(1);}
      100% { box-shadow: 0 2px 128px #7fd7f8ff, 0 0 48px #ffe24bee; transform: scale(1.10);}
    }
    /* Hide top-bar on mobile for more space */
    @media (max-width: 600px) {
      #logo-img {
        height: 90px;
        padding: 8px 8vw;
        margin-top: 10px;
        border-radius: 12vw;
      }
    }
    #game-canvas {
      display: block;
      margin: 0 auto 100px auto; /* Add bottom margin for bottom bar */
      max-width: 100vw;
      background: #232f47;
      border-radius: 22px;
      box-shadow: 0 0 44px #7fd7f888;
      border: 3px solid #7fd7f8;
      outline: none;
      touch-action: none;
      z-index: 1;
      position: relative;
    }
    /* --- Bottom bar --- */
    #bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      background: linear-gradient(90deg, #232f47 55%, #7fd7f8 100%);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      box-shadow: 0 -4px 24px #7fd7f8bb inset, 0 -1px 6px #ffe24b77;
      padding: 12px 0 10px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      transition: background 0.4s;
      flex-wrap: wrap;
    }
    #score-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 1.15em;
      flex-wrap: wrap;
      justify-content: center;
    }
    .score {
      background: rgba(255,255,255,0.86);
      padding: 9px 16px;
      border-radius: 16px;
      border: 3px solid #7fd7f8cc;
      font-weight: bold;
      color: #232f47;
      text-shadow: 0 0 10px #b7aaf7, 0 0 2px #0003;
      letter-spacing: 1.2px;
      font-family: 'Orbitron', 'Manrope', Arial, sans-serif;
      font-size: 1.1em;
      min-width: 72px;
      text-align: center;
      display: inline-block;
      box-shadow: 0 4px 22px #7fd7f844;
      margin: 0 2px;
      transition: background 0.2s, border 0.2s;
    }
    #multiplier-box {
      min-width: 74px;
      background: linear-gradient(90deg,#ffe24bdf 44%,#ff89aa99 100%);
      color: #222;
      border: 3px solid #ffe24b;
      font-weight: bold;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 1px;
      gap: 0;
      transition: background 0.18s, color 0.12s, border 0.13s, min-width 0.13s;
      box-shadow: 0 0 18px #ffe24b66, 0 0 8px #ff89aa44;
    }
    #multiplier-box.inactive {
      background: rgba(255,255,255,0.88);
      color: #555;
      border: 3px solid #b7aaf7;
      opacity: 0.85;
      box-shadow: none;
    }
    #multiplier-box .bonus-label {
      margin-left: 8px;
      font-size: 1em;
      opacity: 0.91;
      font-weight: 900;
      white-space: nowrap;
      color: #a97f00;
      font-family: 'Orbitron', 'Manrope', Arial, sans-serif;
    }
    #multiplier-box .bonus-label.inactive {
      color: #bbb;
      opacity: 0.65;
    }
    .animated {
      animation: bounce 0.5s cubic-bezier(.68,-0.55,.27,1.55);
    }
    @keyframes bounce {
      0% { transform: scale(1);}
      40% { transform: scale(1.3);}
      60% { transform: scale(0.95);}
      80% { transform: scale(1.13);}
      100% { transform: scale(1);}
    }
    /* Improved buttons */
    .btn, #help-btn {
      transition: background 0.17s, color 0.18s, transform 0.13s, box-shadow 0.13s;
      font-family: 'Orbitron', 'Manrope', Arial, sans-serif;
      background: linear-gradient(90deg,#7fd7f8 40%, #ffe24b 100%);
      border-radius: 15px;
      border: 3px solid #7fd7f8;
      padding: 12px 24px;
      color: #1d2438;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 18px #7fd7f833, 0 2px 8px #b7aaf799;
      font-size: 1.12em;
      outline: none;
      margin: 0 0 0 12px;
      letter-spacing: 2px;
    }
    .btn:hover, #help-btn:hover {
      background: linear-gradient(90deg, #ffe24b, #7fd7f8 100%);
      color: #000;
      transform: scale(1.09);
      box-shadow: 0 0 18px #ffe24b66;
      border-color: #ffe24b;
    }
    @media (max-width: 700px) {
      #logo-img { height: 80px; padding: 8px 8vw; margin: 10px auto 2px auto;}
      #bottom-bar { font-size: 0.98em; padding: 7px 0; }
      .score, #multiplier-box { font-size: 0.97em; padding: 6px 8px; min-width: 56px;}
      .btn, #help-btn { font-size: 0.97em; padding: 8px 9px;}
      #game-canvas { margin-bottom: 85px; }
    }
    @media (max-width: 480px) {
      #bottom-bar { padding: 4px 0; }
      .score, #multiplier-box { font-size: 0.95em; padding: 4px 5px; min-width: 40px;}
      .btn, #help-btn { margin: 0; font-size: 0.91em; }
      #game-canvas { margin-bottom: 75px; max-width: 95vw; }
    }
  </style>
</head>
<body>
  <div id="top-bar">
    <img src="img/logo.png" id="logo-img" alt="BenBlinko" />
    <button id="help-btn" class="btn">Help</button>
    <button id="restart-btn" class="btn">Restart</button>
  </div>
  <canvas id="game-canvas" width="480" height="640" tabindex="1"></canvas>
  <div id="bottom-bar">
    <div id="score-bar">
      <span class="score"><b>üèÜ</b> <span id="score-val">0</span></span>
      <span class="score"><b>‚≠ê</b> <span id="highscore-val">0</span></span>
      <span class="score"><b>üî¥</b> <span id="ball-val">1/5</span></span>
      <span id="multiplier-box" class="score inactive">
        <span id="multi-x">x2</span><span class="bonus-label inactive">COMBO</span>
      </span>
    </div>
  </div>
  <script>
  // --- BEGIN GAME LOGIC (preserve your original code) ---
  // Only visual and speed changes made below.
  // If you have a separate JS file, merge the following into it as needed.

  // Example minimal game state (replace with your real logic if more complex)
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');

  // --- GAME CONSTANTS (edit these for much slower gameplay) ---
  const GRAVITY = 0.00007 * canvas.height; // SLOW FALL
  const BOUNCE_DAMPING = 0.46; // SLOW BOUNCE
  const BALL_RADIUS = 11;
  const PEG_RADIUS = 7;
  const ROWS = 9;
  const COLS = 9;
  const PEG_GAP = 48;
  const PEG_Y_START = 100;
  const BALL_START_Y = 48;
  const BALL_SPEED = 2.0; // SLOW HORIZONTAL SPEED
  const BALL_DROP_DELAY = 900; // Slightly longer pause
  
  // --- SCORING BOXES ---
  const SCORE_BOX_HEIGHT = 80;
  const SCORE_BOX_Y = canvas.height - SCORE_BOX_HEIGHT;
  const NUM_SCORE_BOXES = 7;
  const SCORE_BOX_WIDTH = canvas.width / NUM_SCORE_BOXES;
  const SCORE_VALUES = [100, 500, 1000, 5000, 1000, 500, 100]; // Center box has highest value

  // --- GAME STATE ---
  let pegs = [];
  let balls = [];
  let confetti = [];
  let particles = []; // For background particles
  let scorePopups = []; // For floating score numbers
  let lastPegHit = -1;
  let score = 0;
  let highscore = 0;
  let ballsLeft = 5;
  let multiplier = 2;
  let comboActive = false;
  let ballInPlay = false;
  let gameStarted = false; // Track if game has started

  // --- INITIALIZATION ---
  function makePegs() {
    pegs = [];
    for (let row = 0; row < ROWS; ++row) {
      for (let col = 0; col < COLS; ++col) {
        let offset = (row % 2 === 0) ? 0 : PEG_GAP / 2;
        
        // Determine peg type (normal, bonus, multiplier, special)
        let pegType = 'normal';
        let pegValue = 10;
        let pegColor = '#b7aaf7';
        
        // Add some special pegs randomly
        let rand = Math.random();
        if (rand < 0.05) { // 5% chance for multiplier peg
          pegType = 'multiplier';
          pegValue = 50;
          pegColor = '#ff89aa';
        } else if (rand < 0.12) { // 7% chance for bonus peg
          pegType = 'bonus';
          pegValue = 25;
          pegColor = '#ffe24b';
        }
        
        // Make center pegs in later rows more valuable
        if (row >= 5 && Math.abs(col - COLS/2) < 2) {
          if (Math.random() < 0.3) {
            pegType = 'super';
            pegValue = 100;
            pegColor = '#7fd7f8';
          }
        }
        
        pegs.push({
          x: 40 + col * PEG_GAP + offset,
          y: PEG_Y_START + row * PEG_GAP,
          hit: false,
          anim: 0,
          type: pegType,
          value: pegValue,
          color: pegColor,
          originalColor: pegColor
        });
      }
    }
  }
  makePegs();

  function resetGame() {
    score = 0;
    ballsLeft = 5;
    multiplier = 2;
    comboActive = false;
    ballInPlay = false;
    lastPegHit = -1;
    balls = [];
    confetti = [];
    particles = [];
    scorePopups = [];
    gameStarted = true;
    makePegs();
    createBackgroundParticles();
    updateUI();
    setTimeout(dropBall, 1000);
  }
  
  function startGame() {
    gameStarted = true;
    resetGame();
  }
  
  function createBackgroundParticles() {
    // Add subtle floating particles for ambiance
    particles = [];
    for (let i = 0; i < 15; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.3,
        size: Math.random() * 3 + 1,
        opacity: Math.random() * 0.3 + 0.1,
        color: ['#7fd7f8', '#b7aaf7', '#ffe24b'][Math.floor(Math.random() * 3)]
      });
    }
  }
  
  function gameOver() {
    // Show game over message and restart option
    setTimeout(() => {
      if (confirm(`Game Over!\nFinal Score: ${score}\nHigh Score: ${highscore}\n\nPlay Again?`)) {
        resetGame();
      }
    }, 1000);
  }

  function updateUI() {
    document.getElementById('score-val').textContent = score;
    document.getElementById('highscore-val').textContent = highscore;
    document.getElementById('ball-val').textContent = ballsLeft + "/5";
    let mb = document.getElementById('multiplier-box');
    let mx = document.getElementById('multi-x');
    let label = mb.querySelector('.bonus-label');
    if (!comboActive) {
      mb.classList.add('inactive');
      mx.textContent = `x${multiplier}`;
      label.textContent = "COMBO";
      label.classList.add('inactive');
    } else {
      mb.classList.remove('inactive');
      mx.textContent = `x${multiplier}`;
      label.textContent = "COMBO!";
      label.classList.remove('inactive');
    }
  }
  function animateScore(id) {
    let el = document.getElementById(id);
    if (!el) return;
    el.classList.add('animated');
    setTimeout(()=>el.classList.remove('animated'), 500);
  }

  // --- GAMEPLAY ---
  function dropBall() {
    if (ballsLeft <= 0 || ballInPlay) return;
    ballInPlay = true;
    ballsLeft--;
    updateUI();
    animateScore('ball-val');
    balls.push({
      x: canvas.width / 2,
      y: BALL_START_Y,
      vx: (Math.random()-0.5) * BALL_SPEED,
      vy: 0,
      radius: BALL_RADIUS,
      color: "#ffe24b",
      landed: false,
      scored: false
    });
  }

  function update() {
    // Ball physics
    for (let ball of balls) {
      if (ball.landed) continue;
      ball.vy += GRAVITY;
      ball.x += ball.vx;
      ball.y += ball.vy;

      // Wall bounce
      if (ball.x < ball.radius) {
        ball.x = ball.radius; ball.vx = -ball.vx * BOUNCE_DAMPING;
      }
      if (ball.x > canvas.width - ball.radius) {
        ball.x = canvas.width - ball.radius; ball.vx = -ball.vx * BOUNCE_DAMPING;
      }

      // Peg collision
      for (let i=0; i<pegs.length; ++i) {
        let peg = pegs[i];
        let dx = ball.x - peg.x, dy = ball.y - peg.y, dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < ball.radius + PEG_RADIUS && !peg.hit) {
          peg.hit = true;
          peg.anim = 1.0;
          ball.vy = -Math.abs(ball.vy) * BOUNCE_DAMPING;
          
          // Handle different peg types
          let points = peg.value * multiplier;
          if (peg.type === 'multiplier') {
            multiplier += 2; // Extra multiplier boost
            points = peg.value * multiplier;
          } else if (peg.type === 'bonus') {
            points = peg.value * multiplier;
          } else if (peg.type === 'super') {
            points = peg.value * multiplier;
            multiplier += 1;
          } else {
            points = peg.value * multiplier;
            multiplier++;
          }
          
          animateScore('score-val');
          score += points;
          comboActive = true;
          animateScore('multiplier-box');
          
          // Add floating score popup
          scorePopups.push({
            x: peg.x,
            y: peg.y,
            text: `+${points}`,
            color: peg.color,
            life: 60,
            vy: -2
          });
          
          // Confetti - more for special pegs
          let confettiCount = peg.type === 'normal' ? 9 : 15;
          for (let j=0;j<confettiCount;++j) {
            confetti.push({
              x: peg.x, y: peg.y,
              vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*2,
              color: ['#7fd7f8','#b7aaf7','#8dd6e8','#ffe24b','#ff89aa'][j%5],
              t: 0,
              shape: Math.random()<0.5?'circle':'star'
            });
          }
        }
      }

      // Check collision with scoring boxes
      if (ball.y > SCORE_BOX_Y - ball.radius && ball.y < canvas.height - ball.radius && !ball.scored) {
        let boxIndex = Math.floor(ball.x / SCORE_BOX_WIDTH);
        boxIndex = Math.max(0, Math.min(NUM_SCORE_BOXES - 1, boxIndex));
        
        let boxPoints = SCORE_VALUES[boxIndex] * multiplier;
        score += boxPoints;
        ball.scored = true;
        animateScore('score-val');
        
        // Add floating score popup for box score
        scorePopups.push({
          x: ball.x,
          y: SCORE_BOX_Y + SCORE_BOX_HEIGHT/2,
          text: `+${boxPoints}`,
          color: boxIndex === 3 ? '#7fd7f8' : '#ffe24b',
          life: 60,
          vy: -2
        });
        
        // Special confetti for scoring boxes
        for (let j=0;j<12;++j) {
          confetti.push({
            x: ball.x, y: SCORE_BOX_Y + SCORE_BOX_HEIGHT/2,
            vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*3,
            color: boxIndex === 3 ? '#7fd7f8' : ['#ffe24b','#ff89aa','#b7aaf7'][j%3],
            t: 0,
            shape: 'star'
          });
        }
      }

      // Landed
      if (ball.y > canvas.height - ball.radius) {
        ball.y = canvas.height - ball.radius;
        ball.vy = 0; ball.vx = 0;
        ball.landed = true;
        ballInPlay = false;
        setTimeout(()=>{
          // Reset combo if no peg hit on drop
          if (!comboActive) {
            multiplier = 2;
            animateScore('multiplier-box');
          }
          comboActive = false;
          updateUI();
          if (ballsLeft > 0) {
            setTimeout(dropBall, BALL_DROP_DELAY);
          } else {
            // Game over
            gameOver();
          }
        }, 700);
      }
    }
    // Peg hit animation decay
    for (let peg of pegs) if (peg.anim>0) peg.anim -= 0.10;
    // Confetti motion
    for (let c of confetti) {
      c.x += c.vx;
      c.y += c.vy;
      c.vy += 0.12;
      c.t++;
    }
    confetti = confetti.filter(c => c.t < 80);
    
    // Update score popups
    for (let popup of scorePopups) {
      popup.y += popup.vy;
      popup.life--;
    }
    scorePopups = scorePopups.filter(p => p.life > 0);
    
    // Update background particles
    for (let p of particles) {
      p.x += p.vx;
      p.y += p.vy;
      
      // Wrap around screen
      if (p.x < 0) p.x = canvas.width;
      if (p.x > canvas.width) p.x = 0;
      if (p.y < 0) p.y = canvas.height;
      if (p.y > canvas.height) p.y = 0;
    }
    
    // Highscore
    if (score > highscore) { highscore = score; animateScore('highscore-val'); }
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Board bg
    let grd = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
    grd.addColorStop(0, "#313c5d");
    grd.addColorStop(1, "#7fd7f8");
    ctx.fillStyle = grd;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Draw subtle background particles
    for (let p of particles) {
      ctx.save();
      ctx.globalAlpha = p.opacity;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    if (!gameStarted) {
      // Draw entrance screen
      ctx.save();
      ctx.fillStyle = "rgba(45, 58, 87, 0.85)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Large prominent logo text
      ctx.fillStyle = "#ffe24b";
      ctx.font = "bold 48px 'Orbitron', Arial";
      ctx.textAlign = "center";
      ctx.shadowColor = "#7fd7f8";
      ctx.shadowBlur = 20;
      ctx.fillText("BenBlinko", canvas.width/2, canvas.height/2 - 60);
      
      // Subtitle
      ctx.fillStyle = "#7fd7f8";
      ctx.font = "18px 'Manrope', Arial";
      ctx.shadowBlur = 10;
      ctx.fillText("Drop balls ‚Ä¢ Hit pegs ‚Ä¢ Score big!", canvas.width/2, canvas.height/2 - 20);
      
      // Play button
      let buttonY = canvas.height/2 + 40;
      let buttonWidth = 200;
      let buttonHeight = 50;
      let buttonX = canvas.width/2 - buttonWidth/2;
      
      ctx.shadowBlur = 0;
      let btnGrad = ctx.createLinearGradient(buttonX, buttonY, buttonX + buttonWidth, buttonY + buttonHeight);
      btnGrad.addColorStop(0, "#7fd7f8");
      btnGrad.addColorStop(1, "#ffe24b");
      ctx.fillStyle = btnGrad;
      ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);
      
      ctx.strokeStyle = "#ffe24b";
      ctx.lineWidth = 3;
      ctx.strokeRect(buttonX, buttonY, buttonWidth, buttonHeight);
      
      ctx.fillStyle = "#1d2438";
      ctx.font = "bold 20px 'Orbitron', Arial";
      ctx.fillText("PLAY", canvas.width/2, buttonY + 32);
      
      ctx.restore();
      return;
    }

    // Draw scoring boxes at bottom
    for (let i = 0; i < NUM_SCORE_BOXES; i++) {
      let x = i * SCORE_BOX_WIDTH;
      let isCenter = i === 3; // Center box (highest value)
      
      ctx.save();
      // Box background
      let boxGrad = ctx.createLinearGradient(x, SCORE_BOX_Y, x, canvas.height);
      if (isCenter) {
        boxGrad.addColorStop(0, "#7fd7f8");
        boxGrad.addColorStop(1, "#ffe24b");
        // Add glow for center box
        ctx.shadowColor = "#ffe24b";
        ctx.shadowBlur = 15;
      } else {
        boxGrad.addColorStop(0, "#b7aaf7");
        boxGrad.addColorStop(1, "#8dd6e8");
      }
      ctx.fillStyle = boxGrad;
      ctx.fillRect(x, SCORE_BOX_Y, SCORE_BOX_WIDTH, SCORE_BOX_HEIGHT);
      
      // Box border
      ctx.strokeStyle = isCenter ? "#ffe24b" : "#7fd7f8";
      ctx.lineWidth = 3;
      ctx.strokeRect(x, SCORE_BOX_Y, SCORE_BOX_WIDTH, SCORE_BOX_HEIGHT);
      
      // Score text
      ctx.shadowColor = "transparent";
      ctx.shadowBlur = 0;
      ctx.fillStyle = "#1d2438";
      ctx.font = "bold 14px 'Orbitron', Arial";
      ctx.textAlign = "center";
      ctx.fillText(SCORE_VALUES[i].toString(), 
                   x + SCORE_BOX_WIDTH/2, 
                   SCORE_BOX_Y + SCORE_BOX_HEIGHT/2 + 5);
      ctx.restore();
    }

    // Draw pegs
    for (let peg of pegs) {
      ctx.save();
      ctx.beginPath();
      let r = PEG_RADIUS + (peg.anim>0 ? peg.anim*6 : 0);
      ctx.arc(peg.x, peg.y, r, 0, Math.PI*2);
      
      // Use peg-specific colors
      if (peg.hit) {
        ctx.fillStyle = "#ffe24b";
      } else {
        ctx.fillStyle = peg.color;
      }
      
      if (peg.anim>0) {
        ctx.shadowColor = peg.hit ? "#ffe24b" : peg.color;
        ctx.shadowBlur = 18*peg.anim;
      }
      
      // Add glow for special pegs
      if (peg.type !== 'normal' && !peg.hit) {
        ctx.shadowColor = peg.color;
        ctx.shadowBlur = 8;
      }
      
      ctx.globalAlpha = peg.hit ? 0.9 : 0.8;
      ctx.fill();
      
      // Add a ring for special pegs
      if (peg.type !== 'normal' && !peg.hit) {
        ctx.strokeStyle = peg.color;
        ctx.lineWidth = 2;
        ctx.globalAlpha = 0.6;
        ctx.stroke();
      }
      
      ctx.restore();
    }

    // Draw balls
    for (let ball of balls) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
      ctx.fillStyle = ball.color;
      ctx.shadowColor = "#fff";
      ctx.shadowBlur = 12;
      ctx.fill();
      ctx.restore();
    }

    // Draw confetti
    for (let c of confetti) {
      ctx.save();
      ctx.globalAlpha = Math.max(0, 1 - c.t/80);
      ctx.fillStyle = c.color;
      if (c.shape === "star") {
        drawStar(ctx, c.x, c.y, 5, 4, 2.2 + Math.sin(c.t/3) * 1.1);
      } else {
        ctx.beginPath();
        ctx.arc(c.x, c.y, 2.1+Math.sin(c.t/3)*1.05, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    // Draw score popups
    for (let popup of scorePopups) {
      ctx.save();
      ctx.globalAlpha = popup.life / 60;
      ctx.fillStyle = popup.color;
      ctx.font = "bold 16px 'Orbitron', Arial";
      ctx.textAlign = "center";
      ctx.shadowColor = "black";
      ctx.shadowBlur = 4;
      ctx.fillText(popup.text, popup.x, popup.y);
      ctx.restore();
    }
  }

  function drawStar(ctx, x, y, points, outerRadius, innerRadius) {
    let angle = Math.PI / points;
    ctx.beginPath();
    for (let i = 0; i < 2 * points; i++) {
      let r = (i % 2 === 0) ? outerRadius : innerRadius;
      ctx.lineTo(
        x + Math.cos(i * angle) * r,
        y + Math.sin(i * angle) * r
      );
    }
    ctx.closePath();
    ctx.fill();
  }

  function loop() {
    if (!gameStarted) {
      // Update background particles even on entrance screen
      for (let p of particles) {
        p.x += p.vx;
        p.y += p.vy;
        
        // Wrap around screen
        if (p.x < 0) p.x = canvas.width;
        if (p.x > canvas.width) p.x = 0;
        if (p.y < 0) p.y = canvas.height;
        if (p.y > canvas.height) p.y = 0;
      }
    } else {
      update();
    }
    draw();
    requestAnimationFrame(loop);
  }
  
  // Initialize
  createBackgroundParticles();
  loop();

  // --- EVENTS ---
  canvas.addEventListener('pointerdown', function(e) {
    let rect = canvas.getBoundingClientRect();
    let x = (e.clientX - rect.left) * canvas.width / rect.width;
    let y = (e.clientY - rect.top) * canvas.height / rect.height;
    
    if (!gameStarted) {
      // Check if clicked on play button
      let buttonY = canvas.height/2 + 40;
      let buttonWidth = 200;
      let buttonHeight = 50;
      let buttonX = canvas.width/2 - buttonWidth/2;
      
      if (x >= buttonX && x <= buttonX + buttonWidth && 
          y >= buttonY && y <= buttonY + buttonHeight) {
        startGame();
      }
      return;
    }
    
    if (ballInPlay || ballsLeft <= 0) return;
    
    balls.push({
      x: x,
      y: BALL_START_Y,
      vx: (Math.random()-0.5) * BALL_SPEED,
      vy: 0,
      radius: BALL_RADIUS,
      color: "#ffe24b",
      landed: false,
      scored: false
    });
    ballsLeft--;
    updateUI();
    animateScore('ball-val');
    ballInPlay = true;
  });

  document.getElementById('help-btn').onclick = function() {
    alert("BenBlinko\n\nDrop the balls and hit pegs to score!\n\nüü£ Normal Pegs: 10 points\nüü° Bonus Pegs: 25 points\nü©∑ Multiplier Pegs: 50 points + extra multiplier\nüîµ Super Pegs: 100 points + multiplier boost\n\nThe more pegs you hit in a row, the higher your combo multiplier.\n\nBalls land in scoring boxes for bonus points!\nCenter box gives the highest score!\n\nClick anywhere to drop a ball or press SPACE.\n\nGood luck!");
  };

  document.getElementById('restart-btn').onclick = function() {
    if (confirm("Restart game and lose current progress?")) {
      resetGame();
    }
  };

  // Keyboard: space to drop or start game
  window.addEventListener('keydown', e => { 
    if (e.code=="Space") {
      if (!gameStarted) {
        startGame();
      } else {
        dropBall();
      }
    }
  });

  // Keep canvas focus for keyboard on load
  window.onload = () => { 
    canvas.focus(); 
    createBackgroundParticles(); // Start with particles even before game starts
  };

  // --- END GAME LOGIC ---

  </script>
</body>
</html>